<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Assistente Comercial ‚Äî Consultor de Autom√≥veis</title>
<style>
:root{
  --bg:#0b1020; --panel:#0f172a; --muted:#93adc4; --text:#e6eef7; --border:#1f2a44;
  --accent:#22d3ee; --accent-2:#34d399;
}
*{box-sizing:border-box} html,body{margin:0;height:100%}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
  background:radial-gradient(1100px 600px at -10% -10%, rgba(34,211,238,.12), transparent 60%),
             radial-gradient(1200px 800px at 110% -10%, rgba(52,211,153,.12), transparent 60%), var(--bg);
  color:var(--text)}
a{color:var(--accent)}
.header{position:sticky;top:0;z-index:50;background:rgba(11,16,32,.72);backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid var(--border)}
.max{max-width:1200px;margin:0 auto;padding:14px 20px}
.nav{display:flex;align-items:center;gap:14px}
.brand{display:flex;align-items:center;gap:10px}
.brand .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(145deg,var(--accent),var(--accent-2));display:grid;place-items:center;color:#0b1020;font-weight:800}
.brand .name{font-weight:700}
.nav .spacer{flex:1}
.hero{max-width:1200px;margin:0 auto;padding:26px 20px 10px}
.hero .wrap{display:grid;grid-template-columns:1.1fr .9fr;gap:24px;align-items:center}
.h1{font-size:28px;margin:0 0 8px} .sub{color:var(--muted);margin:0 0 16px}
.cta{display:flex;gap:8px;flex-wrap:wrap}
.btn{border:1px solid var(--border);background:linear-gradient(145deg,var(--accent),var(--accent-2));color:#08202a;font-weight:700;padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:0 6px 20px -8px rgba(34,211,238,.6)}
.btn.secondary{background:transparent;color:var(--text)}
.preview{background:rgba(16,24,48,.6);border:1px solid var(--border);border-radius:16px;padding:14px}
.small{color:var(--muted);font-size:12px}
.tabs{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.tab{background:#0e152b;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
.tab.active{background:linear-gradient(145deg,var(--accent),var(--accent-2));color:#0b1020;border-color:transparent;font-weight:700}
main{max-width:1200px;margin:0 auto;padding:12px 20px 40px}
.grid{display:grid;grid-template-columns:360px 1fr;gap:18px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
h3{margin:0 0 10px}
.input, textarea, select, input[type="color"]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b1224;color:var(--text)}
label{display:block;margin-bottom:6px;color:var(--muted)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0d1430;color:#8bf3ff;font-size:12px}
.messages{height:56vh;overflow:auto;display:flex;flex-direction:column;gap:10px;padding-right:4px}
.msg{max-width:78%;padding:10px 12px;border-radius:12px;line-height:1.35;white-space:pre-wrap}
.msg.bot{align-self:flex-start;background:#0d162e;border:1px solid var(--border)}
.msg.user{align-self:flex-end;background:rgba(34,211,238,.15);border:1px solid rgba(34,211,238,.5)}
.composer{display:flex;gap:8px;margin-top:8px} .composer input{flex:1}
.table-wrap{overflow:auto} table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
.kpi{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
.kpi-number{font-size:26px;font-weight:700}
.hidden{display:none !important}
.switch{display:flex;align-items:center;gap:8px}
select.provider{background:#0d1430;border-color:#25406b}
.notice{font-size:12px;color:#ffd080}
</style>
</head>
<body>
<header class="header">
  <div class="max nav">
    <div class="brand">
      <div class="logo">üöó</div>
      <div class="name">Consultor de Autom√≥veis</div>
      <span class="badge">Single-file (local)</span>
    </div>
    <div class="spacer"></div>
    <div class="switch">
      <input type="checkbox" id="useAI"/>
      <label for="useAI">Usar IA via proxy</label>
    </div>
  </div>
</header>

<section class="hero" id="home">
  <div class="wrap">
    <div>
      <h1 class="h1">Chat consultivo + CRM local + Follow-ups</h1>
      <p class="sub">Continua usando o <strong>seu proxy</strong> de IA atual. Sem base externa. Tudo salvo no navegador.</p>
      <div class="cta">
        <a class="btn" href="#demo">Come√ßar a demo</a>
        <a class="btn secondary" href="#crm">CRM</a>
      </div>
      <p class="small">Dica: deixe a **URL do Proxy** apontando para o seu endpoint atual (ex.: <code>/api/chat</code> da sua Vercel), ou selecione um provedor abaixo.</p>
    </div>
    <div class="preview">
      <div class="row">
        <span class="badge">Leads</span>
        <span class="badge">Follow-ups</span>
        <span class="badge">CSV</span>
      </div>
      <p class="small" style="margin-top:8px">Totalmente est√°tico. Ideal para testar e apresentar.</p>
    </div>
  </div>
</section>

<div class="max">
  <div class="tabs" id="tabs">
    <button class="tab active" data-tab="demo">Demo (Chat)</button>
    <button class="tab" data-tab="crm">CRM</button>
    <button class="tab" data-tab="analytics">Analytics</button>
    <button class="tab" data-tab="trainer">Treinar scripts</button>
    <button class="tab" data-tab="personalizar">Personalizar</button>
    <button class="tab" data-tab="sobre">Sobre</button>
  </div>
</div>

<main class="max">
  <!-- Demo -->
  <section id="demo" class="tab-content">
    <div class="grid">
      <aside class="card">
        <h3>Lead atual</h3>
        <div id="leadSnapshot"><p class="small">Nenhum lead ainda.</p></div>
        <div class="row" style="margin-top:8px">
          <button class="btn secondary" id="btnSaveLead">Salvar lead</button>
          <button class="btn secondary" id="btnNewLead">Novo lead</button>
        </div>
        <hr/>
        <label>Provedor/Proxy</label>
        <select id="provider" class="input provider">
          <option value="custom">Usar URL do Proxy (seu /api/chat)</option>
          <option value="gemini">Gemini (se voc√™ tiver /api/chat_gemini)</option>
          <option value="mistral">Mistral (se voc√™ tiver /api/chat_mistral)</option>
        </select>
        <label style="margin-top:10px">URL do Proxy (HTTPS)</label>
        <input id="proxyUrl" class="input" placeholder="/api/chat"/>
        <div class="row">
          <button class="btn secondary" id="btnTest">Testar endpoint</button>
          <span class="small" id="endpointStatus"></span>
        </div>
        <hr/>
        <label>Follow-up (data/hora)</label>
        <input id="nextFollow" class="input" type="datetime-local"/>
        <input id="followNote" class="input" placeholder="Observa√ß√£o do follow-up"/>
        <button class="btn secondary" id="btnSetFollow">Salvar follow-up</button>
        <div class="small notice" id="followWarn" style="display:none">‚ö†Ô∏è Voc√™ tem follow-ups vencidos na aba Analytics.</div>
      </aside>
      <div class="card">
        <div id="messages" class="messages"></div>
        <div class="composer">
          <input id="userInput" class="input" placeholder="Escreva aqui... (ex.: Quero um carro econ√¥mico para fam√≠lia de 4)"/>
          <button class="btn" id="sendBtn">Enviar</button>
        </div>
      </div>
    </div>
  </section>

  <!-- CRM -->
  <section id="crm" class="tab-content hidden">
    <div class="kpis">
      <div class="kpi"><div class="kpi-number" id="kpiLeads">0</div><div>Leads</div></div>
      <div class="kpi"><div class="kpi-number" id="kpiQual">0</div><div>Qualificados</div></div>
      <div class="kpi"><div class="kpi-number" id="kpiQuote">0</div><div>Recomenda√ß√£o enviada</div></div>
      <div class="kpi"><div class="kpi-number" id="kpiWon">0</div><div>Fechados</div></div>
    </div>
    <div class="card">
      <div class="row" style="margin-bottom:10px">
        <input class="input" id="search" placeholder="Buscar por nome, telefone, produto, status..."/>
        <button class="btn secondary" id="exportCsv">Exportar CSV</button>
        <button class="btn secondary" id="clearCrm">Limpar CRM</button>
      </div>
      <div class="table-wrap">
        <table id="crmTable">
          <thead><tr><th>Status</th><th>Nome</th><th>Perfil</th><th>Telefone</th><th>Score</th><th>Follow-up</th><th>Atualizado</th><th>A√ß√µes</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Analytics -->
  <section id="analytics" class="tab-content hidden">
    <div class="card">
      <h3>Vis√£o geral</h3>
      <div class="kpis">
        <div class="kpi"><div class="kpi-number" id="aLeads">0</div><div>Leads</div></div>
        <div class="kpi"><div class="kpi-number" id="aObjPreco">0</div><div>Obje√ß√µes: pre√ßo</div></div>
        <div class="kpi"><div class="kpi-number" id="aObjConsumo">0</div><div>Prioridade: consumo</div></div>
        <div class="kpi"><div class="kpi-number" id="aObjEspaco">0</div><div>Prioridade: espa√ßo</div></div>
      </div>
      <h3>Pr√≥ximos follow-ups</h3>
      <ul id="followups"></ul>
    </div>
  </section>

  <!-- Trainer -->
  <section id="trainer" class="tab-content hidden">
    <div class="card">
      <h3>Treinar scripts (Consultor de Autom√≥veis)</h3>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <label>Sauda√ß√£o / Abertura</label>
          <textarea id="tGreeting" rows="4" class="input"></textarea>
        </div>
        <div>
          <label>Fechamento / Pr√≥ximo passo</label>
          <textarea id="tClosing" rows="4" class="input"></textarea>
        </div>
        <div>
          <label>Perguntas de Descoberta (uma por linha)</label>
          <textarea id="tDiscovery" rows="6" class="input"></textarea>
        </div>
        <div>
          <label>Tratamento de Obje√ß√µes (JSON)</label>
          <textarea id="tObjections" rows="6" class="input" placeholder='{"preco":"...","consumo":"..."}'></textarea>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnSaveTraining">Salvar</button>
        <button class="btn secondary" id="btnLoadSample">Carregar exemplos</button>
        <button class="btn secondary" id="btnClearTraining">Apagar</button>
        <button class="btn secondary" id="btnExportConfig">Exportar configura√ß√£o (.json)</button>
        <input type="file" id="importFile" class="hidden" accept=".json"/>
        <button class="btn secondary" id="btnImportConfig">Importar configura√ß√£o</button>
      </div>
    </div>
  </section>

  <!-- Personalizar -->
  <section id="personalizar" class="tab-content hidden">
    <div class="card">
      <h3>Branding & Tema</h3>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <label>Nome do consultor</label>
          <input id="sAgent" class="input" placeholder="Tiago"/>
          <label style="margin-top:10px">Nome do neg√≥cio</label>
          <input id="sBiz" class="input" placeholder="Consultoria Auto Tiago"/>
          <label style="margin-top:10px">Produtos</label>
          <input id="sProducts" class="input" placeholder="Consultoria automotiva, compra, troca, financiamento"/>
        </div>
        <div>
          <div class="row" style="margin-top:10px">
            <div>
              <label>Cor prim√°ria</label>
              <input type="color" id="cPrimary" value="#22d3ee"/>
            </div>
            <div>
              <label>Cor secund√°ria</label>
              <input type="color" id="cSecondary" value="#34d399"/>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnSaveTheme">Salvar tema</button>
            <button class="btn secondary" id="btnResetTheme">Restaurar tema</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Sobre -->
  <section id="sobre" class="tab-content hidden">
    <div class="card">
      <h3>Sobre esta vers√£o</h3>
      <p>Funciona 100% no navegador, salvando no <strong>localStorage</strong>. O chat usa o <strong>seu endpoint</strong> (proxy) atual. Voc√™ pode alternar para <code>/api/chat_gemini</code> ou <code>/api/chat_mistral</code> se tiver adicionado ao mesmo projeto.</p>
    </div>
  </section>
</main>

<script>
// ===== Storage & Defaults =====
const LS = { SETTINGS:"auto_settings", TRAINING:"auto_training", CRM:"auto_crm" };
const defaults = {
  settings: { agent:"Tiago", biz:"Consultoria Auto Tiago", products:"Consultoria automotiva, compra, troca, financiamento", provider:"custom", proxyUrl:"/api/chat" },
  training: {
    greeting: "Ol√°! Sou seu consultor de autom√≥veis. Vou te ajudar a escolher o carro ideal considerando or√ßamento, uso e custo total (TCO), sem enrola√ß√£o.",
    discovery: [
      "Carro novo ou usado? Algum modelo/ano em mente?",
      "Qual √© seu or√ßamento (√† vista ou parcela mensal)? Tem entrada?",
      "Uso principal (cidade/rodovia/app/fam√≠lia)? Quilometragem/ano?",
      "Prioridades (consumo, conforto, tecnologia, desempenho, espa√ßo, seguran√ßa)?",
      "Combust√≠vel preferido (flex/h√≠brido/el√©trico)? C√¢mbio (manual/autom√°tico)?",
      "CEP para estimar seguro/IPVA?",
      "Tem carro para troca?"
    ],
    objections: {
      preco: "Se o valor ficou alto, trago op√ß√µes com ano/modelo alternativos ou vers√µes mais enxutas mantendo seguran√ßa.",
      consumo: "Posso priorizar modelos econ√¥micos (h√≠bridos/flex) e calcular o payback no seu uso.",
      manutencao: "Trago estimativa anual de manuten√ß√£o e disponibilidade de pe√ßas para cada modelo.",
      seguro: "Incluo uma estimativa de seguro baseada no perfil/CEP e mostramos o impacto no custo mensal.",
      espaco: "Analisamos porta-malas, espa√ßo traseiro e isofix; comparo SUVs compactos e sedans mais espa√ßosos.",
      depreciacao: "Mostro deprecia√ß√£o m√©dia (3‚Äì5 anos) e como influencia o TCO."
    },
    closing: "Te envio 2‚Äì3 op√ß√µes com pr√≥s/contras, consumo e custos. Me passe nome e telefone para formalizar e te chamar no WhatsApp."
  }
};
let settings = JSON.parse(localStorage.getItem(LS.SETTINGS)||"null") || defaults.settings;
let training = JSON.parse(localStorage.getItem(LS.TRAINING)||"null") || defaults.training;
let crm = JSON.parse(localStorage.getItem(LS.CRM)||"null") || [];

function saveCRM(){ localStorage.setItem(LS.CRM, JSON.stringify(crm)); }
function saveSettings(){ localStorage.setItem(LS.SETTINGS, JSON.stringify(settings)); }
function saveTraining(){ localStorage.setItem(LS.TRAINING, JSON.stringify(training)); }

// ===== Tabs =====
const tabs = document.querySelectorAll(".tab");
const sections = document.querySelectorAll(".tab-content");
tabs.forEach(b=> b.addEventListener("click", ()=>{
  tabs.forEach(x=>x.classList.remove("active"));
  sections.forEach(s=>s.classList.add("hidden"));
  b.classList.add("active");
  document.getElementById(b.dataset.tab).classList.remove("hidden");
  if (b.dataset.tab === "crm") renderCRM();
  if (b.dataset.tab === "analytics") renderAnalytics();
  if (b.dataset.tab === "trainer") loadTrainer();
  if (b.dataset.tab === "personalizar") loadPersonalize();
}));

// ===== Theme & Branding =====
function applyTheme(){
  document.documentElement.style.setProperty("--accent", theme.accent || "#22d3ee");
  document.documentElement.style.setProperty("--accent-2", theme.accent2 || "#34d399");
}
let theme = { accent:"#22d3ee", accent2:"#34d399" };
function loadPersonalize(){
  document.getElementById("sAgent").value = settings.agent;
  document.getElementById("sBiz").value = settings.biz;
  document.getElementById("sProducts").value = settings.products;
  document.getElementById("cPrimary").value = theme.accent;
  document.getElementById("cSecondary").value = theme.accent2;
}
document.getElementById("btnSaveTheme").onclick = ()=>{
  settings.agent = document.getElementById("sAgent").value || "Tiago";
  settings.biz = document.getElementById("sBiz").value || "Consultoria Auto Tiago";
  settings.products = document.getElementById("sProducts").value || defaults.settings.products;
  theme.accent = document.getElementById("cPrimary").value || "#22d3ee";
  theme.accent2 = document.getElementById("cSecondary").value || "#34d399";
  saveSettings(); applyTheme(); alert("Tema e branding salvos.");
};
document.getElementById("btnResetTheme").onclick = ()=>{
  settings = JSON.parse(JSON.stringify(defaults.settings));
  theme = { accent:"#22d3ee", accent2:"#34d399" };
  saveSettings(); loadPersonalize(); applyTheme();
  alert("Tema restaurado.");
};

// ===== Chat =====
const messagesEl = document.getElementById("messages");
const useAIEl = document.getElementById("useAI");
const providerEl = document.getElementById("provider");
const proxyUrlEl = document.getElementById("proxyUrl");
providerEl.value = settings.provider || "custom";
proxyUrlEl.value = settings.proxyUrl || "/api/chat";
useAIEl.checked = !!settings.proxyUrl;

function appendMsg(sender, text){
  const div = document.createElement("div"); div.className = "msg " + (sender === "bot" ? "bot" : "user"); div.textContent = text;
  messagesEl.appendChild(div); messagesEl.scrollTop = messagesEl.scrollHeight;
}
function bot(t){ appendMsg("bot", t); currentLead.transcript.push({who:settings.agent, text:t, ts:new Date().toISOString()}); }
function user(t){ appendMsg("user", t); currentLead.transcript.push({who:"Cliente", text:t, ts:new Date().toISOString()}); }

let currentLead = newLead();
let chatStarted=false, step=0;
function newLead(){
  return {
    id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
    name:"", phone:"", email:"", status:"Novo", score:0,
    new_or_used:"", model_hint:"", budget_month:"", budget_cash:"", use_case:"", annual_km:"",
    priorities:[], fuel:"", gearbox:"", cep:"",
    created_at:new Date().toISOString(), updated_at:new Date().toISOString(),
    transcript:[], next_followup_at:null, followup_note:""
  };
}
function start(){
  bot(`${training.greeting}\nTrabalho com ${settings.products}. Voc√™ quer falar sobre carro novo ou usado? Tem algum modelo/ano em mente?`);
}
const userInput = document.getElementById("userInput");
document.getElementById("sendBtn").onclick = handleSend;
userInput.addEventListener("keydown", e=> (e.key==="Enter") && handleSend());

function effectiveEndpoint(){
  const p = providerEl.value;
  if (p==="gemini") return "/api/chat_gemini";
  if (p==="mistral") return "/api/chat_mistral";
  return proxyUrlEl.value || "/api/chat";
}
providerEl.onchange = ()=>{
  settings.provider = providerEl.value;
  if (settings.provider==="custom" && !settings.proxyUrl) proxyUrlEl.value="/api/chat";
  if (settings.provider==="gemini") proxyUrlEl.value="/api/chat_gemini";
  if (settings.provider==="mistral") proxyUrlEl.value="/api/chat_mistral";
  saveSettings();
};

async function handleSend(){
  const t = userInput.value.trim(); if (!t) return; userInput.value = "";
  user(t);
  if (!chatStarted){ chatStarted = true; step=1; ask1(); return; }

  // IA (se ligado)
  if (useAIEl.checked && effectiveEndpoint()){
    try{
      const sys = buildSystemPrompt();
      const payload = { system: sys, messages: currentLead.transcript.slice(-20) };
      const res = await fetch(effectiveEndpoint(), { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error("Falha no proxy ("+res.status+")");
      const data = await res.json();
      bot(data.text || "(sem resposta)");
      updateLeadSnapshot(); return;
    }catch(e){ bot("N√£o consegui falar com a IA agora. Vou seguir o fluxo offline. ("+e.message+")"); }
  }

  // Fluxo offline
  processOffline(t);
}

function buildSystemPrompt(){
  return `Voc√™ √© um consultor de autom√≥veis da ${settings.biz} chamado ${settings.agent}.
Tom: consultivo, objetivo e claro.
Sauda√ß√£o: ${training.greeting}
Perguntas: ${training.discovery.join(" | ")}
Obje√ß√µes: ${JSON.stringify(training.objections)}
Fechamento: ${training.closing}
Quando houver inten√ß√£o clara, pe√ßa nome e telefone para qualificar o lead.`;
}

// Perguntas guiadas
function ask1(){ bot("Novo ou usado? Algum modelo/ano em mente?"); }
function ask2(){ bot("Or√ßamento: √† vista (R$) ou mensal (parcela)? Tem entrada?"); }
function ask3(){ bot("Uso (cidade/rodovia/app/fam√≠lia) e quilometragem/ano?"); }
function ask4(){ bot("Prioridades (consumo, conforto, tecnologia, desempenho, espa√ßo, seguran√ßa)?"); }
function ask5(){ bot("Prefer√™ncia de combust√≠vel (flex/h√≠brido/el√©trico), c√¢mbio (manual/autom√°tico) e seu CEP?"); }
function ask6(){ bot("Seu nome e telefone (ex.: Maria 41999998888), para formalizar as recomenda√ß√µes."); }

function includesAny(text, arr){ const l=text.toLowerCase(); return arr.some(k=> l.includes(k.toLowerCase())); }
function extractNum(text){ const m=text.match(/\d+/g); return m? m.join("") : ""; }
function processOffline(text){
  switch(step){
    case 1:
      currentLead.new_or_used = includesAny(text,["novo","zero"])?"Novo": (includesAny(text,["usado","semi"]))?"Usado":currentLead.new_or_used;
      if (!currentLead.model_hint) currentLead.model_hint=text;
      step=2; ask2(); break;
    case 2:
      if (!currentLead.budget_cash && (text.includes("√† vista")||text.includes("a vista"))) currentLead.budget_cash = extractNum(text);
      if (!currentLead.budget_month && includesAny(text,["parcela","mensal","m√™s","mes"])) currentLead.budget_month = extractNum(text);
      if (!currentLead.budget_cash && !currentLead.budget_month) currentLead.budget_month = extractNum(text);
      step=3; ask3(); break;
    case 3:
      if (!currentLead.use_case) currentLead.use_case = text;
      if (!currentLead.annual_km) currentLead.annual_km = extractNum(text);
      step=4; ask4(); break;
    case 4:
      currentLead.priorities = text.split(/,|;|\//).map(s=>s.trim()).filter(Boolean);
      step=5; ask5(); break;
    case 5:
      if (!currentLead.fuel) currentLead.fuel = includesAny(text,["h√≠brido","hibrido"])?"H√≠brido": includesAny(text,["el√©trico","eletrico"])?"El√©trico": includesAny(text,["flex"])?"Flex":"";
      if (!currentLead.gearbox) currentLead.gearbox = includesAny(text,["autom√°tico","automatico"])?"Autom√°tico": includesAny(text,["manual"])?"Manual":"";
      if (!currentLead.cep) currentLead.cep = extractNum(text);
      step=6; ask6(); break;
    case 6:
      const m = text.match(/(\+?\d{10,14})/);
      if (m){ currentLead.phone = m[0]; currentLead.name = text.replace(m[0],"").trim(); currentLead.status="Qualificado"; currentLead.score = scoreLead(currentLead); }
      updateLeadSnapshot(); break;
  }
  // obje√ß√µes
  const l=text.toLowerCase();
  if (l.includes("pre√ßo")||l.includes("preco")||l.includes("caro")) bot(training.objections.preco);
  if (l.includes("consumo")) bot(training.objections.consumo);
  if (l.includes("manuten")) bot(training.objections.manutencao);
  if (l.includes("seguro")) bot(training.objections.seguro);
  if (l.includes("espa√ßo")||l.includes("espaco")) bot(training.objections.espaco);
  if (l.includes("deprec")) bot(training.objections.depreciacao);
}

function scoreLead(L){
  let s=0;
  if (L.new_or_used) s+=10;
  if (L.model_hint) s+=10;
  if (L.budget_cash||L.budget_month) s+=20;
  if (L.use_case) s+=10;
  if ((L.priorities||[]).length) s+=10;
  if (L.phone && L.phone.length>=10) s+=30;
  if (L.cep) s+=5;
  if ((L.priorities||[]).join(",").match(/consumo|seguran|espa|famil/i)) s+=5;
  return Math.min(100,s);
}

function updateLeadSnapshot(){
  const L=currentLead;
  L.updated_at = new Date().toISOString();
  document.getElementById("leadSnapshot").innerHTML = `
    <div class="badge">${L.status}</div>
    <p><strong>${L.name||"(sem nome)"} </strong> ‚Ä¢ Tel ${L.phone||"-"} ‚Ä¢ Score ${L.score||0}</p>
    <p>${L.new_or_used||"-"} ‚Ä¢ ${L.model_hint||"-"}</p>
    <p>Or√ßamento: √† vista R$ ${L.budget_cash||"-"} ‚Ä¢ mensal R$ ${L.budget_month||"-"}</p>
    <p>Uso: ${L.use_case||"-"} ‚Ä¢ km/ano ${L.annual_km||"-"} ‚Ä¢ CEP ${L.cep||"-"}</p>
    <p>Prefer√™ncias: ${L.priorities?.join(", ")||"-"} ‚Ä¢ ${L.fuel||"-"} ‚Ä¢ ${L.gearbox||"-"}</p>
  `;
  checkFollowupsWarning();
}

// ===== A√ß√µes do lead
document.getElementById("btnSaveLead").onclick = ()=>{
  const i = crm.findIndex(x=>x.id===currentLead.id);
  if (i>=0) crm[i]=currentLead; else crm.push(currentLead);
  saveCRM(); renderCRM(); alert("Lead salvo no CRM (local).");
};
document.getElementById("btnNewLead").onclick = ()=>{
  currentLead = newLead(); chatStarted=false; step=0;
  document.getElementById("messages").innerHTML = ""; start();
};

document.getElementById("btnSetFollow").onclick = ()=>{
  const dt = document.getElementById("nextFollow").value; const note = document.getElementById("followNote").value;
  currentLead.next_followup_at = dt? new Date(dt).toISOString(): null; currentLead.followup_note = note||"";
  updateLeadSnapshot();
  const i = crm.findIndex(x=>x.id===currentLead.id);
  if (i>=0) crm[i]=currentLead; else crm.push(currentLead);
  saveCRM(); renderCRM(); alert("Follow-up salvo (local).");
};

// ===== Teste de endpoint
document.getElementById("btnTest").onclick = async ()=>{
  const url = effectiveEndpoint();
  document.getElementById("endpointStatus").textContent = "Testando...";
  try{
    const r = await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ system:"Teste", messages:[{who:"Cliente", text:"Ol√°"}] }) });
    document.getElementById("endpointStatus").textContent = "Status: " + r.status;
  }catch(e){ document.getElementById("endpointStatus").textContent = "Falha: " + e.message; }
};

// ===== CRM
function renderCRM(){
  const tbody=document.querySelector("#crmTable tbody");
  const q=(document.getElementById("search").value||"").toLowerCase();
  const list=crm.filter(L=> !q || (`${L.name} ${L.phone} ${L.status} ${L.model_hint}`).toLowerCase().includes(q));
  document.getElementById("kpiLeads").textContent=crm.length;
  document.getElementById("kpiQual").textContent=crm.filter(x=>x.status==="Qualificado").length;
  document.getElementById("kpiQuote").textContent=crm.filter(x=>x.status==="Recomenda√ß√£o enviada").length;
  document.getElementById("kpiWon").textContent=crm.filter(x=>x.status==="Fechado").length;
  tbody.innerHTML="";
  list.forEach(L=>{
    const perfil = `${L.new_or_used||"-"} | ${L.model_hint||"-"} | ${(L.priorities||[]).slice(0,2).join("/")||"-"}`;
    const nf = L.next_followup_at ? new Date(L.next_followup_at).toLocaleString() : "-";
    const tr=document.createElement("tr");
    tr.innerHTML = `<td><span class="badge">${L.status}</span></td>
      <td>${L.name||"-"}</td><td>${perfil}</td><td>${L.phone||"-"}</td>
      <td>${L.score||0}</td><td>${nf}</td>
      <td>${new Date(L.updated_at||L.created_at).toLocaleString()}</td>
      <td>
        <button class="btn secondary open" data-id="${L.id}">Abrir</button>
        <button class="btn secondary stage" data-id="${L.id}">Avan√ßar</button>
        <button class="btn secondary del" data-id="${L.id}">Excluir</button>
      </td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll(".open").forEach(b=> b.onclick = (e)=>{
    const id=e.target.getAttribute("data-id"); const L=crm.find(x=>x.id===id); if(!L) return;
    currentLead=JSON.parse(JSON.stringify(L));
    document.querySelector('.tab[data-tab="demo"]').click();
    bot("Lead reaberto no chat."); updateLeadSnapshot();
  });
  tbody.querySelectorAll(".stage").forEach(b=> b.onclick = (e)=>{
    const id=e.target.getAttribute("data-id"); const L=crm.find(x=>x.id===id); if(!L) return;
    const order=["Novo","Qualificado","Recomenda√ß√£o enviada","Fechamento","Fechado"];
    const i=order.indexOf(L.status); L.status=order[Math.min(order.length-1, Math.max(0,i+1))]||"Qualificado";
    L.updated_at=new Date().toISOString(); saveCRM(); renderCRM();
  });
  tbody.querySelectorAll(".del").forEach(b=> b.onclick = (e)=>{
    const id=e.target.getAttribute("data-id");
    crm = crm.filter(x=>x.id!==id); saveCRM(); renderCRM();
  });
}
document.getElementById("search").oninput = renderCRM;
document.getElementById("exportCsv").onclick = ()=>{
  const headers=["id","status","name","phone","new_or_used","model_hint","budget_cash","budget_month","use_case","annual_km","priorities","fuel","gearbox","cep","score","next_followup_at","followup_note","created_at","updated_at"];
  const rows=[headers.join(",")];
  crm.forEach(L=>{
    const row=headers.map(h=>{
      const v=(h==="priorities")? (L.priorities||[]).join("|") : (L[h]??"");
      return `"${String(v).replace(/"/g,'""')}"`;
    }).join(",");
    rows.push(row);
  });
  const blob=new Blob([rows.join("\n")],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="crm.csv"; a.click(); URL.revokeObjectURL(url);
};
document.getElementById("clearCrm").onclick = ()=>{
  if (!confirm("Apagar todos os leads do CRM (local)?")) return;
  crm=[]; saveCRM(); renderCRM();
};

// ===== Analytics
function renderAnalytics(){
  document.getElementById("aLeads").textContent = crm.length;
  let preco=0, consumo=0, espaco=0;
  crm.forEach(L=> (L.transcript||[]).forEach(m=>{
    const t=(m.text||"").toLowerCase();
    if (t.includes("pre√ßo")||t.includes("preco")||t.includes("caro")) preco++;
    if (t.includes("consumo")) consumo++;
    if (t.includes("espa√ßo")||t.includes("espaco")||t.includes("porta-malas")) espaco++;
  }));
  document.getElementById("aObjPreco").textContent = preco;
  document.getElementById("aObjConsumo").textContent = consumo;
  document.getElementById("aObjEspaco").textContent = espaco;
  const ul=document.getElementById("followups"); ul.innerHTML="";
  crm.filter(L=>L.next_followup_at).sort((a,b)=> new Date(a.next_followup_at)-new Date(b.next_followup_at)).slice(0,10).forEach(L=>{
    const li=document.createElement("li"); li.textContent = `${L.name||"Lead"} ‚Ä¢ ${new Date(L.next_followup_at).toLocaleString()} ‚Ä¢ ${L.followup_note||""}`; ul.appendChild(li);
  });
}

// ===== Trainer
function loadTrainer(){
  document.getElementById("tGreeting").value = training.greeting || "";
  document.getElementById("tDiscovery").value = (training.discovery||[]).join("\n");
  document.getElementById("tObjections").value = JSON.stringify(training.objections||{}, null, 2);
  document.getElementById("tClosing").value = training.closing || "";
}
document.getElementById("btnSaveTraining").onclick = ()=>{
  try{
    const obj = JSON.parse(document.getElementById("tObjections").value || "{}");
    training = {
      greeting: document.getElementById("tGreeting").value || defaults.training.greeting,
      discovery: (document.getElementById("tDiscovery").value||"").split("\n").filter(Boolean),
      objections: obj,
      closing: document.getElementById("tClosing").value || defaults.training.closing
    };
    saveTraining(); alert("Treinamento salvo!");
  }catch(e){ alert("JSON de obje√ß√µes inv√°lido."); }
};
document.getElementById("btnLoadSample").onclick = ()=>{
  training = JSON.parse(JSON.stringify(defaults.training));
  saveTraining(); loadTrainer(); alert("Exemplos carregados.");
};
document.getElementById("btnClearTraining").onclick = ()=>{
  localStorage.removeItem(LS.TRAINING); training = JSON.parse(JSON.stringify(defaults.training)); loadTrainer(); alert("Treinamento apagado (exemplos restaurados).");
};
document.getElementById("btnExportConfig").onclick = ()=>{
  const data = { settings, training, theme };
  const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="config-assistente.json"; a.click(); URL.revokeObjectURL(url);
};
document.getElementById("btnImportConfig").onclick = ()=> document.getElementById("importFile").click();
document.getElementById("importFile").addEventListener("change",(e)=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const data = JSON.parse(reader.result);
      if (data.settings) { settings = data.settings; saveSettings(); }
      if (data.training) { training = data.training; saveTraining(); }
      if (data.theme) { theme = data.theme; applyTheme(); }
      loadTrainer(); loadPersonalize(); alert("Configura√ß√£o importada!");
    }catch(e){ alert("Arquivo inv√°lido."); }
  };
  reader.readAsText(file);
});

// ===== Follow-ups: alerta visual
function hasOverdueFollowups(){
  const now = Date.now();
  return crm.some(L => L.next_followup_at && new Date(L.next_followup_at).getTime() < now);
}
function checkFollowupsWarning(){
  const warn = document.getElementById("followWarn");
  if (hasOverdueFollowups()){ warn.style.display="block"; } else { warn.style.display="none"; }
}
// Fa√ßa uma checagem a cada 60s
setInterval(checkFollowupsWarning, 60000);

// ===== Boot
function boot(){
  applyTheme();
  document.querySelector('.tab[data-tab="demo"]').click();
  proxyUrlEl.value = settings.proxyUrl || "/api/chat";
  providerEl.value = settings.provider || "custom";
  setTimeout(()=>{
    bot(`Ol√°! Eu sou ${settings.agent} da ${settings.biz}.`);
    bot("Diga se prefere carro novo ou usado e seu or√ßamento/uso. Eu retorno com 2‚Äì3 op√ß√µes.");
  }, 250);
}
document.getElementById("proxyUrl").addEventListener("change", ()=>{
  settings.proxyUrl = document.getElementById("proxyUrl").value || "/api/chat";
  saveSettings();
});
boot();
</script>
</body>
</html>
