<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Consultor de Autom√≥veis ‚Äî IA (Tempo Real + CRM)</title>
<style>
:root{
  --bg:#0b1020; --panel:#0f172a; --muted:#93adc4; --text:#e6eef7; --border:#1f2a44;
  --accent:#22d3ee; --accent-2:#34d399;
}
*{box-sizing:border-box} html,body{margin:0;height:100%}
body{
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
  background:radial-gradient(1100px 600px at -10% -10%, rgba(34,211,238,.12), transparent 60%),
             radial-gradient(1200px 800px at 110% -10%, rgba(52,211,153,.12), transparent 60%), var(--bg);
  color:var(--text)
}
a{color:var(--accent)}
.header{position:sticky;top:0;z-index:50;background:rgba(11,16,32,.72);backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid var(--border)}
.max{max-width:1200px;margin:0 auto;padding:14px 20px}
.nav{display:flex;align-items:center;gap:14px}
.brand{display:flex;align-items:center;gap:10px}
.brand .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(145deg,var(--accent),var(--accent-2));display:grid;place-items:center;color:#0b1020;font-weight:800}
.brand .name{font-weight:700}
.nav .spacer{flex:1}
.tabs{display:flex;gap:8px;margin:10px auto 0;flex-wrap:wrap}
.tab{background:#0e152b;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
.tab.active{background:linear-gradient(145deg,var(--accent),var(--accent-2));color:#0b1020;border-color:transparent;font-weight:700}
main{max-width:1200px;margin:0 auto;padding:12px 20px 40px}
.grid{display:grid;grid-template-columns:360px 1fr;gap:18px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
h3{margin:0 0 10px}
.input, textarea, select, input[type="color"]{
  width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b1224;color:var(--text)
}
label{display:block;margin-bottom:6px;color:var(--muted)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0d1430;color:#8bf3ff;font-size:12px}
.messages{height:60vh;overflow:auto;display:flex;flex-direction:column;gap:10px;padding-right:4px}
.msg{max-width:78%;padding:10px 12px;border-radius:12px;line-height:1.35;white-space:pre-wrap}
.msg.bot{align-self:flex-start;background:#0d162e;border:1px solid var(--border)}
.msg.user{align-self:flex-end;background:rgba(34,211,238,.15);border:1px solid rgba(34,211,238,.5)}
.composer{display:flex;gap:8px;margin-top:8px} .composer input{flex:1}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
.kpi{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
.kpi-number{font-size:26px;font-weight:700}
.table-wrap{overflow:auto} table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
.hidden{display:none !important}
.small{font-size:12px;color:var(--muted)}
.btn{border:1px solid var(--border);background:linear-gradient(145deg,var(--accent),var(--accent-2));color:#08202a;font-weight:700;padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:0 6px 20px -8px rgba(34,211,238,.6)}
.btn.secondary{background:transparent;color:var(--text)}
.notice{font-size:12px;color:#ffd080}
.debug{font-family:ui-monospace,Consolas,monospace;background:#0b1224;border:1px dashed #24304c;border-radius:10px;padding:10px;white-space:pre-wrap;max-height:180px;overflow:auto}
.pill{display:inline-block;border:1px solid var(--border);padding:2px 8px;border-radius:999px;margin-right:6px;margin-bottom:6px;background:#0d1430;color:var(--muted);font-size:12px}
.pill.option,.pill.selected{cursor:pointer}
.pill.selected{background:var(--accent);color:#08202a}
.pill.option{border-style:dashed}
</style>
</head>
<body>
<header class="header">
  <div class="max nav">
    <div class="brand">
      <div class="logo">üöó</div>
      <div class="name">Consultor de Autom√≥veis ‚Äî IA</div>
      <span class="badge">Tempo Real + Prompt</span>
    </div>
    <div class="spacer"></div>
    <div class="row">
      <label class="small">Endpoint</label>
      <input id="endpoint" class="input" style="width:360px" value="/api/chat_gemini" />
      <button class="btn secondary" id="testEP">Testar</button>
      <span id="epStatus" class="small"></span>
    </div>
  </div>
</header>

<div class="max">
  <div class="tabs" id="tabs">
    <button class="tab active" data-tab="chat">Chat</button>
    <button class="tab" data-tab="crm">CRM</button>
    <button class="tab" data-tab="analytics">Analytics</button>
    <button class="tab" data-tab="prompt">Prompt da IA</button>
    <button class="tab" data-tab="config">Perguntas</button>
  </div>
</div>

<main class="max">
  <!-- CHAT -->
  <section id="chat" class="tab-content">
    <div class="grid">
      <aside class="card">
        <h3>Lead atual</h3>
        <div id="leadSnapshot"><p class="small">Nenhum lead ainda.</p></div>
        <h4>Carros sugeridos</h4>
        <div id="carRecs"><p class="small">Nenhum carro sugerido.</p></div>
        <div class="row" style="margin-top:8px">
          <button class="btn secondary" id="btnSaveLead">Salvar lead</button>
          <button class="btn secondary" id="btnNewLead">Novo lead</button>
        </div>
        <hr/>
        <label>Follow-up (data/hora)</label>
        <input id="nextFollow" class="input" type="datetime-local"/>
        <input id="followNote" class="input" placeholder="Observa√ß√£o do follow-up"/>
        <button class="btn secondary" id="btnSetFollow">Salvar follow-up</button>
        <p id="followWarn" class="notice hidden">‚ö†Ô∏è Voc√™ tem follow-ups vencidos na aba Analytics.</p>
        <hr/>
        <label><input type="checkbox" id="autoAppt" /> Agendar automaticamente se a IA sugerir</label>
        <p class="small">Frases como ‚Äúvamos agendar amanh√£ 15:00‚Äù ser√£o detectadas e o follow-up criado automaticamente.</p>
        <hr/>
        <h3>Debug (JSON extra√≠do pela IA)</h3>
        <div id="debugBox" class="debug small">‚Äî</div>
        <hr/>
        <h3>Tags autom√°ticas</h3>
        <div id="autoTags"></div>
      </aside>

      <div class="card">
        <div id="messages" class="messages"></div>
        <div class="composer">
          <input id="userInput" class="input" placeholder="Ex.: Carro econ√¥mico para fam√≠lia, at√© R$ 150.000, autom√°tico" />
          <button class="btn" id="sendBtn">Enviar</button>
        </div>
      </div>
    </div>
  </section>

  <!-- CRM -->
  <section id="crm" class="tab-content hidden">
    <div class="kpis">
      <div class="kpi"><div class="kpi-number" id="kpiLeads">0</div><div>Leads</div></div>
      <div class="kpi"><div class="kpi-number" id="kpiQual">0</div><div>Qualificados</div></div>
      <div class="kpi"><div class="kpi-number" id="kpiRec">0</div><div>Recomenda√ß√£o enviada</div></div>
      <div class="kpi"><div class="kpi-number" id="kpiWon">0</div><div>Fechados</div></div>
    </div>
    <div class="card">
      <div class="row" style="margin-bottom:10px">
        <input class="input" id="search" placeholder="Buscar por nome, telefone, perfil, status..."/>
        <button class="btn secondary" id="exportCsv">Exportar CSV</button>
        <button class="btn secondary" id="clearCrm">Limpar CRM</button>
      </div>
      <div class="table-wrap">
        <table id="crmTable">
          <thead><tr><th>Status</th><th>Nome</th><th>Perfil</th><th>Telefone</th><th>Score</th><th>Follow-up</th><th>Atualizado</th><th>A√ß√µes</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Analytics -->
  <section id="analytics" class="tab-content hidden">
    <div class="card">
      <h3>Vis√£o geral</h3>
      <div class="kpis">
        <div class="kpi"><div class="kpi-number" id="aLeads">0</div><div>Leads</div></div>
        <div class="kpi"><div class="kpi-number" id="aPreco">0</div><div>Obje√ß√µes: pre√ßo</div></div>
        <div class="kpi"><div class="kpi-number" id="aConsumo">0</div><div>Prioridade: consumo</div></div>
        <div class="kpi"><div class="kpi-number" id="aEspaco">0</div><div>Prioridade: espa√ßo</div></div>
      </div>
      <h3>Pr√≥ximos follow-ups</h3>
      <ul id="followups"></ul>
    </div>
  </section>

  <!-- Prompt da IA -->
  <section id="prompt" class="tab-content hidden">
    <div class="card">
      <h3>Prompt do Gemini (System)</h3>
      <p class="small">Personalize o comportamento do consultor. Vari√°veis: <code>{{biz}}</code>, <code>{{agent}}</code>.</p>
      <textarea id="promptEditor" class="input" rows="22"></textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="savePrompt">Salvar Prompt</button>
        <button class="btn secondary" id="resetPrompt">Restaurar padr√£o</button>
      </div>
      <hr/>
      <label>Agendamento inteligente</label>
      <p class="small">Se a IA sugerir ‚Äúagendar‚Äù com data/hor√°rio, podemos criar o follow-up autom√°tico (ative na aba Chat).</p>
    </div>
  </section>

  <!-- Editor de Perguntas -->
  <section id="config" class="tab-content hidden">
    <div class="card">
      <h3>Roteiro de Perguntas</h3>
      <p class="small">Edite as perguntas que o chat far√° em sequ√™ncia (uma por linha).</p>
      <textarea id="questionsEditor" class="input" rows="12"></textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="saveQuestions">Salvar</button>
        <button class="btn secondary" id="resetQuestions">Restaurar padr√£o</button>
      </div>
    </div>
  </section>
</main>

<script>
/* ================== ESTADO & STORAGE ================== */
const LS = { SETTINGS:"auto_settings", CRM:"auto_crm", PROMPT:"auto_prompt", QUESTIONS:"auto_questions" };
let crm = JSON.parse(localStorage.getItem(LS.CRM)||"null") || [];
let settings = JSON.parse(localStorage.getItem(LS.SETTINGS)||"null") || { agent:"Tiago", biz:"Consultoria Auto Tiago" };
let customPrompt = localStorage.getItem(LS.PROMPT) || masterPrompt();

const defaultQuestions = [
  "Carro novo ou usado? Algum modelo/ano em mente?",
  "Qual √© seu or√ßamento (√† vista ou parcela mensal)?",
  "Uso principal (cidade/rodovia/app/fam√≠lia)? Quilometragem/ano?",
  "Prioridades (consumo, conforto, tecnologia, desempenho, espa√ßo, seguran√ßa)?",
  "Combust√≠vel preferido (flex/h√≠brido/el√©ctrico)? C√¢mbio (manual/autom√°tico)?",
  "CEP para estimar seguro/IPVA?",
  "Tem carro para troca?",
  "Seu nome e telefone para contato?"
];
const closingMsg = "Obrigado! Em breve envio op√ß√µes de carros conforme seu perfil.";
let questions = JSON.parse(localStorage.getItem(LS.QUESTIONS)||"null") || defaultQuestions.slice();
let questionIdx = 0;

/* ================== UI B√ÅSICA / TABS ================== */
const tabs = document.querySelectorAll(".tab");
const sections = document.querySelectorAll(".tab-content");
tabs.forEach(b=> b.addEventListener("click", ()=>{
  tabs.forEach(x=>x.classList.remove("active"));
  sections.forEach(s=>s.classList.add("hidden"));
  b.classList.add("active");
  document.getElementById(b.dataset.tab).classList.remove("hidden");
  if (b.dataset.tab === "crm") renderCRM();
  if (b.dataset.tab === "analytics") renderAnalytics();
  if (b.dataset.tab === "prompt") loadPromptEditor();
  if (b.dataset.tab === "config") loadQuestionsEditor();
}));

/* ================== ELEMENTOS ================== */
const messagesEl = document.getElementById("messages");
const userInput = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");
const endpointEl = document.getElementById("endpoint");
const testEP = document.getElementById("testEP");
const epStatus = document.getElementById("epStatus");
const autoApptEl = document.getElementById("autoAppt");
const debugBox = document.getElementById("debugBox");
const autoTags = document.getElementById("autoTags");

document.getElementById("btnSaveLead").onclick = onSaveLead;
document.getElementById("btnNewLead").onclick = onNewLead;
document.getElementById("btnSetFollow").onclick = onManualFollow;
document.getElementById("exportCsv").onclick = exportCsv;
document.getElementById("clearCrm").onclick = clearCrm;
document.getElementById("search").oninput = renderCRM;
testEP.onclick = doTestEP;
sendBtn.onclick = handleSend;
userInput.addEventListener("keydown", e=> (e.key==="Enter") && handleSend());

/* ================== PROMPT EDITOR ================== */
const promptEditor = document.getElementById("promptEditor");
const savePrompt = document.getElementById("savePrompt");
const resetPrompt = document.getElementById("resetPrompt");
savePrompt.onclick = ()=>{
  customPrompt = promptEditor.value || customPrompt;
  localStorage.setItem(LS.PROMPT, customPrompt);
  alert("Prompt salvo!");
};
resetPrompt.onclick = ()=>{
  localStorage.removeItem(LS.PROMPT);
  customPrompt = masterPrompt();
  loadPromptEditor();
  alert("Prompt restaurado ao padr√£o mestre.");
};
function loadPromptEditor(){ promptEditor.value = localStorage.getItem(LS.PROMPT) || customPrompt || masterPrompt(); }

/* ================== PERGUNTAS (ROTEIRO) ================== */
const questionsEditor = document.getElementById("questionsEditor");
const saveQuestions = document.getElementById("saveQuestions");
const resetQuestions = document.getElementById("resetQuestions");
saveQuestions.onclick = ()=>{
  questions = questionsEditor.value.split("\n").map(s=>s.trim()).filter(Boolean);
  localStorage.setItem(LS.QUESTIONS, JSON.stringify(questions));
  alert("Perguntas salvas!");
};
resetQuestions.onclick = ()=>{
  localStorage.removeItem(LS.QUESTIONS);
  questions = defaultQuestions.slice();
  loadQuestionsEditor();
  alert("Perguntas restauradas ao padr√£o.");
};
function loadQuestionsEditor(){ if (questionsEditor) questionsEditor.value = (questions||[]).join("\n"); }

/* ================== LEAD & CHAT ================== */
let currentLead = newLead();

function newLead(){
  return {
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
      name:"", phone:"", email:"", status:"Novo", score:0,
      new_or_used:"", model_hint:"", budget_month:"", budget_cash:"", use_case:"", annual_km:"",
      priorities:[], suggested_prios:[], recommendations:[], fuel:"", gearbox:"", cep:"",
      next_followup_at:null, followup_note:"",
    created_at:new Date().toISOString(), updated_at:new Date().toISOString(),
    transcript:[]
  };
}

function appendMsg(sender, text){
  const clean = sanitize(text);
  const div = document.createElement("div"); 
  div.className = "msg " + (sender === "bot" ? "bot" : "user"); 
  div.textContent = clean;
  messagesEl.appendChild(div); messagesEl.scrollTop = messagesEl.scrollHeight;

    // EXTRA√á√ÉO HEUR√çSTICA EM TEMPO REAL (local) ‚Äî atualiza snapshot imediatamente
    if (sender === "user"){
      heuristicExtract(clean);
      currentLead.updated_at = new Date().toISOString();
      autoScoreAndSave();
      updateLeadSnapshot();
      renderTags();
    }
  }
  function bot(t){ appendMsg("bot", t); currentLead.transcript.push({who:"Consultor", text:sanitize(t), ts:new Date().toISOString()}); }
  function user(t){ appendMsg("user", t); currentLead.transcript.push({who:"Cliente", text:sanitize(t), ts:new Date().toISOString()}); }

  function sanitize(s){
    return String(s||"")
      .replace(/\[(insira|inserir).*?\]/gi,"")
      .replace(/\{\{.*?\}\}/g,"")
      .replace(/\s{2,}/g," ")
      .trim();
  }

  function fmtBRL(v){
    const n=parseFloat(String(v).replace(/[^0-9,.-]/g,"").replace(/,/g,"."));
    return isNaN(n)?"-":n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  }

  function makeAck(p){
    const parts=[];
    if(p.new_or_used) parts.push(`carro ${p.new_or_used.toLowerCase()}`);
    if(p.budget_cash) parts.push(`or√ßamento √† vista ${fmtBRL(p.budget_cash)}`);
    if(p.budget_month) parts.push(`parcela at√© ${fmtBRL(p.budget_month)}/m√™s`);
    if(p.use_case) parts.push(`uso ${p.use_case.toLowerCase()}`);
    if(p.priorities && p.priorities.length) parts.push(`foco em ${p.priorities.join("/")}`);
    return parts.length? `Entendido: ${parts.join(", ")}.` : "Perfeito, obrigado.";
  }

/* ================== FLUXO DO CHAT ================== */
async function handleSend(){
  const t = userInput.value.trim(); if (!t) return; userInput.value = "";
  user(t);
  const convo = currentLead.transcript.slice(-20);
  const extracted = await aiExtractLead(convo);
  if (extracted){ mergeLeadData(extracted); autoScoreAndSave(); updateLeadSnapshot(); renderTags(); }

  const ack = makeAck(extracted||{});
  bot(ack);

  if (questionIdx < questions.length-1){
    questionIdx++;
    bot(questions[questionIdx]);
  } else {
    bot(closingMsg);
  }

  if (autoApptEl.checked && extracted){
    const when = parseScheduleFrom(extracted);
    if (when && !currentLead.next_followup_at){
      const note = await aiFollowupNote(convo);
      currentLead.next_followup_at = when.toISOString();
      currentLead.followup_note = note || defaultFollowNote();
      autoScoreAndSave(); updateLeadSnapshot();
      bot(`Agendado automaticamente para ${when.toLocaleString()}.`);
    }
  }
}


/* ============ EXTRA√á√ÉO HEUR√çSTICA EM TEMPO REAL (local) ============ */
function heuristicExtract(text){
  let changed=false;
  const L=currentLead;
  const low=text.toLowerCase();

  // telefone
  const tel = text.match(/(\+?\d[\d\s\-\.]{8,}\d)/);
  if (tel){ const d = tel[0].replace(/\D/g,""); if (d.length>=10 && d!==L.phone){ L.phone=d; L.status = L.status==="Novo"?"Qualificado":L.status; changed=true; } }

  // CEP
  const cep = text.match(/\b\d{5}[- ]?\d{3}\b/);
  if (cep){ const d=cep[0].replace(/\D/g,""); if (d!==L.cep){ L.cep=d; changed=true; } }

  // or√ßamento (R$ ou n√∫mero com milhar) ‚Äî distingue mensal vs √† vista por palavra-chave
  const money = text.match(/(?:r\$\s*)?(\d{1,3}(?:[\.\s]\d{3})+|\d+)(?:[,\.]\d{2})?/i);
  if (money){
    const raw = money[0].replace(/[^\d,\.]/g,"").replace(/\./g,"").replace(",","."); 
    const val = String(parseFloat(raw||"0")||"");
    if (/m[e√™]nsal|parcela|por m[e√™]s|m√™s|mes/.test(low)){
      if (val && val!==L.budget_month){ L.budget_month = val; changed=true; }
    } else if (/√† vista|a vista|avista|√†v ista|a-vista/.test(low)){
      if (val && val!==L.budget_cash){ L.budget_cash = val; changed=true; }
    } else {
      // se n√£o h√° hint, preenche mensal se vazio sen√£o √† vista
      if (!L.budget_month && val){ L.budget_month = val; changed=true; }
      else if (!L.budget_cash && val){ L.budget_cash = val; changed=true; }
    }
  }

  // novo/usado
  if (/novo|zero/.test(low) && L.new_or_used!=="Novo"){ L.new_or_used="Novo"; changed=true; }
  if (/(usado|semi[-\s]?novo)/.test(low) && L.new_or_used!=="Usado"){ L.new_or_used="Usado"; changed=true; }

  // combust√≠vel
  if (/h[i√≠]brido/.test(low) && L.fuel!=="H√≠brido"){ L.fuel="H√≠brido"; changed=true; }
  if (/el[e√©]trico/.test(low) && L.fuel!=="El√©trico"){ L.fuel="El√©trico"; changed=true; }
  if (/flex/.test(low) && L.fuel!=="Flex"){ L.fuel="Flex"; changed=true; }

  // c√¢mbio
  if (/autom[a√°]tico/.test(low) && L.gearbox!=="Autom√°tico"){ L.gearbox="Autom√°tico"; changed=true; }
  if (/manual/.test(low) && L.gearbox!=="Manual"){ L.gearbox="Manual"; changed=true; }

  // e-mail
  const email = text.match(/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}/i);
  if (email && email[0] !== L.email){ L.email = email[0].toLowerCase(); changed = true; }

  // prioridades
    const prios=[];
    if (/consumo|econ[o√¥]mico/.test(low)) prios.push("consumo");
    if (/conforto/.test(low)) prios.push("conforto");
    if (/tecnologia|multim[i√≠]dia|adas/.test(low)) prios.push("tecnologia");
    if (/desempenho|pot[e√™]ncia|motor/.test(low)) prios.push("desempenho");
    if (/espa[√ßc]o|porta-?malas|fam[i√≠]lia/.test(low)) prios.push("espa√ßo");
    if (/seguran[√ßc]a|airbag|esc|aba|adas/.test(low)) prios.push("seguran√ßa");
    if (/manuten[√ßc][a√£]o|pe[√ßc]as/.test(low)) prios.push("manuten√ß√£o");
    if (prios.length){
      const set = new Set([...(L.suggested_prios||[]), ...prios]);
      const arr = Array.from(set);
      if (arr.join("|") !== (L.suggested_prios||[]).join("|")){ L.suggested_prios = arr; changed=true; }
    }

  // uso / km/ano
  if (/cidade|urbano/.test(low) && (!L.use_case || !/cidade|urbano/i.test(L.use_case))) { L.use_case = "Cidade"; changed=true; }
  if (/rodovia|estrada/.test(low) && (!L.use_case || !/rodovia|estrada/i.test(L.use_case))) { L.use_case = "Rodovia"; changed=true; }
  const km = text.match(/\b(\d{4,6})\s*(km|quil[o√¥]metros?)\b/i);
  if (km && !L.annual_km){ L.annual_km = km[1]; changed=true; }

  // modelo hint (heur√≠stica simples: palavra com inicial mai√∫scula seguida de n√∫mero/termo t√≠pico)
  const model = text.match(/\b([A-Z√Å√Ä√Ç√É√â√ä√ç√ì√î√ï√ö√á][a-z0-9]+(?:\s+[A-Z0-9][a-z0-9]+){0,2})\s?(?:\d{4}|1\.0|1,0|2\.0|2,0)?\b/);
  if (model){
    const mh = model[0];
    if (mh && mh.length>2 && (!L.model_hint || L.model_hint.indexOf(mh)===-1)){
      L.model_hint = (L.model_hint? (L.model_hint + "; "):"") + mh;
      changed=true;
    }
  }

  // schedule r√°pido (ex.: 12/09 14:30)
  const dt = parseDateTimePtBR(text);
  if (dt && autoApptEl.checked && !L.next_followup_at){
    L.next_followup_at = dt.toISOString();
    L.followup_note = defaultFollowNote();
    changed=true;
  }

  if (changed){ L.updated_at = new Date().toISOString(); }
  return changed;
}

/* ============ EXTRA√á√ÉO POR IA (JSON) ============ */
function parseScheduleFrom(obj){
  if (!obj || !obj.schedule_text) return null;
  return parseDateTimePtBR(obj.schedule_text);
}

async function aiExtractLead(messages){
  try{
    const convo = messages.map(m=>`${m.who}: ${m.text}`).join("\n");
    const sys = extractorPrompt();
    const r = await fetch(endpointEl.value||"/api/chat_gemini",{
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ system: sys, messages:[{who:"Transcri√ß√£o", text: convo}] })
    });
    const j = await r.json();
    const raw = sanitize(j.text||"");
    let data=null; 
    try{ data = JSON.parse(raw); } catch(e){ 
      const q = raw.match(/\{[\s\S]*\}$/); if (q){ try{ data = JSON.parse(q[0]); }catch(_){} }
    }
    debugBox.textContent = data? JSON.stringify(data,null,2) : "(sem JSON v√°lido)";
    return data||null;
  }catch(e){
    debugBox.textContent = "erro: "+e.message;
    return null;
  }
}

  function mergeLeadData(p){
    const L=currentLead;
    const assign = (k)=>{ if (p[k]) L[k]=p[k]; };
    ["name","phone","email","new_or_used","model_hint","budget_cash","budget_month","use_case","annual_km","fuel","gearbox","cep"].forEach(assign);
    if (Array.isArray(p.priorities) && p.priorities.length){
      L.suggested_prios = Array.from(new Set([...(L.suggested_prios||[]), ...p.priorities]));
    }
    if (Array.isArray(p.recommendations) && p.recommendations.length){
      L.recommendations = p.recommendations.map(r=>({model:r.model||r.name||"", price:Number(r.price)||0}));
    }
    L.updated_at = new Date().toISOString();
  }

function autoScoreAndSave(){
  currentLead.score = scoreLead(currentLead);
  const i = crm.findIndex(x=>x.id===currentLead.id);
  if (i>=0) crm[i]=currentLead; else crm.push(currentLead);
  localStorage.setItem(LS.CRM, JSON.stringify(crm));
  renderCRM();
}

/* ================== PROMPTS (MESTRE / EXTRATOR / FOLLOWUP) ================== */
function masterPrompt(){
return `Voc√™ √© {{agent}}, consultor de autom√≥veis da {{biz}}. Sua miss√£o √© ajudar o cliente a definir o carro ideal considerando necessidades, or√ßamento, custo total de propriedade (TCO) e prefer√™ncias pessoais ‚Äî sem empurrar produtos. Atue com clareza, objetividade e gentileza, sempre oferecendo valor pr√°tico.

ESTILO
- Tom: consultivo, emp√°tico, direto ao ponto.
- Linguagem simples; quando usar termos t√©cnicos, defina em 1 linha.
- NUNCA use placeholders, colchetes, ‚Äúpreencha aqui‚Äù ou campos vazios. Entregue texto pronto.
- Par√°grafos curtos + listas simples na compara√ß√£o.
- Responda no mesmo idioma do cliente (padr√£o: PT-BR).

DESCOBERTA (colete com naturalidade)
1) Novo ou usado; modelos/anos em mente.
2) Or√ßamento (√† vista e/ou mensal) e entrada.
3) Uso principal (cidade/rodovia/app/fam√≠lia) e km/ano.
4) Prioridades: consumo, conforto, tecnologia, desempenho, espa√ßo/porta-malas, seguran√ßa, manuten√ß√£o.
5) Combust√≠vel (flex/h√≠brido/el√©trico) e c√¢mbio (manual/autom√°tico).
6) CEP (estimativa de seguro/IPVA).
7) Nome e telefone quando houver inten√ß√£o real (para formalizar proposta/contato).
8) Se houver interesse, ofere√ßa agendar conversa r√°pida com data/hor√°rio.

RECOMENDA√á√ïES (sempre que poss√≠vel)
- Traga 2‚Äì3 op√ß√µes adequadas ao perfil. Para cada uma:
  ‚Ä¢ Modelo/ano t√≠pico, pontos fortes e limita√ß√µes
  ‚Ä¢ Consumo aproximado (urbano/rodovi√°rio quando fizer sentido)
  ‚Ä¢ Itens de seguran√ßa relevantes (ex.: 6 airbags, ESC, ADAS)
  ‚Ä¢ Manuten√ß√£o estimada/intervalos; seguro (no√ß√£o qualitativa: baixo/m√©dio/alto)
  ‚Ä¢ TCO resumido (frase curta: combust√≠vel + manuten√ß√£o + seguro + deprecia√ß√£o)
- Explique por que atende √†s prioridades do cliente.
- Se or√ßamento estiver justo, ofere√ßa varia√ß√£o (ano anterior/vers√£o) para caber no bolso.
- Evite promessas absolutas; use estimativas e condicionais.

OBJE√á√ïES & REDIRECIONAMENTOS
- Pre√ßo alto ‚Üí vers√µes/anos alternativos; ajuste de equipamentos.
- Consumo ‚Üí economia real vs. uso; h√≠bridos/compactos eficientes.
- Manuten√ß√£o ‚Üí rede, intervalos, pe√ßas.
- Seguro ‚Üí varia por perfil/CEP; classifique baixo/m√©dio/alto.
- Espa√ßo ‚Üí compare SUVs compactos x sedans/monovolumes.
- Deprecia√ß√£o ‚Üí populares perdem menos valor.

AGENDAMENTO
- Sugira agendar 10‚Äì15 min.
- Se o cliente der data/hor√°rio, confirme.
- Se n√£o der, pergunte: ‚ÄúQual dia e hor√°rio prefere? (ex.: 12/09 14:30)‚Äù.
- Gere uma nota curta de follow-up com objetivo do pr√≥ximo passo.

FORMATA√á√ÉO
- Comece com um resumo do que entendeu (X e Y; prioridade Z).
- Em seguida, lista comparativa das 2‚Äì3 op√ß√µes.
- Finalize com pr√≥ximos passos (ex.: ‚ÄúPosso formalizar a proposta e agendar 10 min?‚Äù).
- NUNCA retorne placeholders/colchetes/templates vazios.

SE√á√ÉO OCULTA DE EXTRA√á√ÉO (opcional, apenas se houver dados novos)
Inclua AO FINAL da resposta, sem afetar o texto para o cliente, um bloco:
<!--EXTRACTION
{"name":null,"phone":null,"new_or_used":null,"model_hint":null,"budget_cash":null,"budget_month":null,"use_case":null,"annual_km":null,"priorities":[],"fuel":null,"gearbox":null,"cep":null,"schedule_text":null}
EXTRACTION-->
Regras: apenas se tiver algo novo; apenas JSON v√°lido (uma linha); sem coment√°rios; "schedule_text" deve conter uma frase de data/hor√°rio quando o cliente informar.`;
}

function extractorPrompt(){
return `Apenas devolva JSON v√°lido (sem texto extra) com os campos:
{"name":null,"phone":null,"new_or_used":null,"model_hint":null,"budget_cash":null,"budget_month":null,"use_case":null,"annual_km":null,"priorities":[],"fuel":null,"gearbox":null,"cep":null,"schedule_text":null}
Regras:
- Leia a transcri√ß√£o completa fornecida.
- Telefone apenas d√≠gitos (10‚Äì14).
- N√£o invente valores. Se n√£o souber, use null.
- Sem code fences nem coment√°rios.`;
}

function followupNotePrompt(){
return `Gere UMA linha objetiva de nota para o follow-up, sem emojis e sem informa√ß√µes inventadas.
Foque em or√ßamento, prioridades (ex.: consumo/espa√ßo/seguran√ßa) e pr√≥ximos passos (ex.: comparar duas op√ß√µes, confirmar prazo/seguro).
Retorne apenas a frase final.`;
}

/* ================== AGENDAMENTO & UTIL ================== */
function defaultFollowNote(){
  const L=currentLead;
  return `Contato com ${L.name||"Lead"}: validar or√ßamento R$${L.budget_month||L.budget_cash||"?"}/m√™s, prioridades ${(L.priorities||[]).slice(0,3).join("/")||"?"}.`;
}
async function aiFollowupNote(messages){
  try{
    const convo = messages.map(m=>`${m.who}: ${m.text}`).join("\n");
    const sys = followupNotePrompt();
    const r = await fetch(endpointEl.value||"/api/chat_gemini",{
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ system: sys, messages:[{who:"Transcri√ß√£o", text: convo}] })
    });
    const j = await r.json();
    return sanitize(j.text||"").slice(0,240);
  }catch(e){ return ""; }
}

function parseDateTimePtBR(s){
  const t = s.replace(/\s+√†s\s+/i," ").replace(/\s+as\s+/i," ").replace("h",":");
  const m = t.match(/(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?(?:\s+(\d{1,2})(?::(\d{2}))?)?/);
  if(!m) return null;
  let [_,dd,MM,yyyy,hh,mm] = m;
  const now = new Date();
  const year = yyyy? (yyyy.length===2? 2000+parseInt(yyyy): parseInt(yyyy)) : now.getFullYear();
  const date = new Date(year, parseInt(MM)-1, parseInt(dd), parseInt(hh||"9"), parseInt(mm||"0"));
  return isNaN(date.getTime())? null : date;
}

/* ================== BOT√ïES & AUXILIARES ================== */
function onManualFollow(){
  const dt = document.getElementById("nextFollow").value;
  const note = document.getElementById("followNote").value;
  currentLead.next_followup_at = dt? new Date(dt).toISOString(): null;
  currentLead.followup_note = sanitize(note||"");
  autoScoreAndSave(); updateLeadSnapshot();
  alert("Follow-up salvo (local).");
}
function onSaveLead(){ autoScoreAndSave(); alert("Lead salvo no CRM (local)."); }
function onNewLead(){
  currentLead = newLead();
  messagesEl.innerHTML = "";
  questionIdx = 0;
  bot(`Ol√°! Eu sou ${settings.agent} da ${settings.biz}.`);
  bot(questions[questionIdx]);
  updateLeadSnapshot();
  renderTags();
}
async function doTestEP(){
  epStatus.textContent = "Testando...";
  const r = await fetch(endpointEl.value||"/api/chat_gemini",{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ system:"teste", messages:[{who:"Cliente", text:"Ol√°!"}] })
  }).catch(e=>({ok:false,status:e.message}));
  if (r && r.ok !== undefined){
    const txt = r.ok ? "OK" : "Falha";
    epStatus.textContent = `${txt} (${r.status||"?"})`;
  }else{
    epStatus.textContent = "Erro de rede";
  }
}

/* ================== SNAPSHOT / SCORE / TAGS ================== */
const SCORE_WEIGHTS = {
  name:10,
  phone:30,
  email:10,
  budget:20,
  profile:10,
  priorities:10,
  followup:5,
  extras:5
};

function scoreLead(L){
  let s=0;
  if (L.name) s+=SCORE_WEIGHTS.name;
  if (L.phone && L.phone.replace(/\D/g,"").length>=10) s+=SCORE_WEIGHTS.phone;
  else if (L.email) s+=SCORE_WEIGHTS.email; // contato alternativo
  if (L.budget_cash||L.budget_month) s+=SCORE_WEIGHTS.budget;
  if (L.new_or_used||L.model_hint) s+=SCORE_WEIGHTS.profile;
  if ((L.priorities||[]).length) s+=SCORE_WEIGHTS.priorities;
  if (L.next_followup_at) s+=SCORE_WEIGHTS.followup;
  if (L.fuel||L.gearbox||L.cep) s+=SCORE_WEIGHTS.extras;
  return Math.min(100,s);
}

function updateLeadSnapshot(){
  const L=currentLead;
  L.updated_at = new Date().toISOString();
  document.getElementById("leadSnapshot").innerHTML = `
    <div class="badge">${L.status}</div>
    <p><strong>${sanitize(L.name)||"(sem nome)"} </strong> ‚Ä¢ Tel ${L.phone||"-"} ‚Ä¢ Email ${sanitize(L.email)||"-"} ‚Ä¢ Score ${L.score||0}</p>
    <p>${L.new_or_used||"-"} ‚Ä¢ ${sanitize(L.model_hint)||"-"}</p>
    <p>Or√ßamento: √† vista ${fmtBRL(L.budget_cash)} ‚Ä¢ mensal ${fmtBRL(L.budget_month)}</p>
    <p>Uso: ${sanitize(L.use_case)||"-"} ‚Ä¢ km/ano ${L.annual_km||"-"} ‚Ä¢ CEP ${L.cep||"-"}</p>
    <p>Prefer√™ncias: ${sanitize((L.priorities||[]).join(", "))||"-"} ‚Ä¢ ${L.fuel||"-"} ‚Ä¢ ${L.gearbox||"-"}</p>
    <p>Follow-up: ${L.next_followup_at? new Date(L.next_followup_at).toLocaleString():"-"} ‚Ä¢ ${sanitize(L.followup_note||"")}</p>
  `;
  const recs=(L.recommendations||[]).slice().sort((a,b)=>a.price-b.price);
  document.getElementById("carRecs").innerHTML = recs.length ? `<ul>${recs.map(r=>`<li>${sanitize(r.model)} - ${fmtBRL(r.price)}</li>`).join("")}</ul>` : "<p class='small'>Nenhum carro sugerido.</p>";
  const overdue = crm.some(x=>x.next_followup_at && new Date(x.next_followup_at).getTime() < Date.now());
  document.getElementById("followWarn").classList.toggle("hidden", !overdue);
}

function renderTags(){
  const L=currentLead;
  const extras=[];
  if (L.new_or_used) extras.push(L.new_or_used);
  if (L.fuel) extras.push(L.fuel);
  if (L.gearbox) extras.push(L.gearbox);
  if (L.budget_month) extras.push(`${fmtBRL(L.budget_month)}/m√™s`);
  if (L.cep) extras.push(`CEP ${L.cep}`);
  const prios=(L.priorities||[]).slice().sort();
  const sugg=(L.suggested_prios||[]).filter(p=>!prios.includes(p)).slice().sort();
  const html=[
    ...extras.map(t=>`<span class="pill">${sanitize(t)}</span>`),
    ...prios.map(t=>`<span class="pill selected" data-tag="${sanitize(t)}">${sanitize(t)}</span>`),
    ...sugg.map(t=>`<span class="pill option" data-tag="${sanitize(t)}">${sanitize(t)} +</span>`)
  ].join("");
  autoTags.innerHTML = html || "<span class='small'>Sem tags ainda.</span>";
  autoTags.querySelectorAll('.pill.selected').forEach(el=>{
    el.onclick=()=>{
      const tag=el.getAttribute('data-tag');
      const idx=L.priorities.indexOf(tag);
      if(idx>=0) L.priorities.splice(idx,1);
      autoScoreAndSave(); renderTags(); updateLeadSnapshot();
    };
  });
  autoTags.querySelectorAll('.pill.option').forEach(el=>{
    el.onclick=()=>{
      const tag=el.getAttribute('data-tag');
      L.priorities=L.priorities||[];
      if(!L.priorities.includes(tag)) L.priorities.push(tag);
      autoScoreAndSave(); renderTags(); updateLeadSnapshot();
    };
  });
}

/* ================== CRM / ANALYTICS ================== */
function renderCRM(){
  const tbody=document.querySelector("#crmTable tbody");
  const q=(document.getElementById("search").value||"").toLowerCase();
  const list=crm
    .slice()
    .sort((a,b)=> new Date(b.updated_at||b.created_at) - new Date(a.updated_at||a.created_at))
    .filter(L=> !q || (`${L.name} ${L.phone} ${L.email} ${L.status} ${L.model_hint}`).toLowerCase().includes(q));
  setText("kpiLeads", crm.length);
  setText("kpiQual", crm.filter(x=>x.status==="Qualificado").length);
  setText("kpiRec",  crm.filter(x=>x.status==="Recomenda√ß√£o enviada").length);
  setText("kpiWon",  crm.filter(x=>x.status==="Fechado").length);
  tbody.innerHTML="";
  list.forEach(L=>{
    const perfil = `${L.new_or_used||"-"} | ${sanitize(L.model_hint)||"-"} | ${(L.priorities||[]).slice(0,2).join("/")||"-"}`;
    const nf = L.next_followup_at ? new Date(L.next_followup_at).toLocaleString() : "-";
    const tr=document.createElement("tr");
    tr.innerHTML = `<td><span class="badge">${L.status}</span></td>
      <td>${sanitize(L.name)||"-"}</td><td>${perfil}</td><td>${L.phone||"-"}</td>
      <td>${L.score||0}</td><td>${nf}</td>
      <td>${new Date(L.updated_at||L.created_at).toLocaleString()}</td>
      <td>
        <button class="btn secondary open" data-id="${L.id}">Abrir</button>
        <button class="btn secondary stage" data-id="${L.id}">Avan√ßar</button>
        <button class="btn secondary del" data-id="${L.id}">Excluir</button>
      </td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll(".open").forEach(b=> b.onclick = (e)=>{
    const id=e.target.getAttribute("data-id"); const L=crm.find(x=>x.id===id); if(!L) return;
    currentLead=JSON.parse(JSON.stringify(L));
    document.querySelector('.tab[data-tab="chat"]').click();
    bot("Lead reaberto no chat."); updateLeadSnapshot(); renderTags();
  });
  tbody.querySelectorAll(".stage").forEach(b=> b.onclick = (e)=>{
    const id=e.target.getAttribute("data-id"); const L=crm.find(x=>x.id===id); if(!L) return;
    const order=["Novo","Qualificado","Recomenda√ß√£o enviada","Fechamento","Fechado"];
    const i=order.indexOf(L.status); L.status=order[Math.min(order.length-1, Math.max(0,i+1))]||"Qualificado";
    L.updated_at=new Date().toISOString(); localStorage.setItem(LS.CRM, JSON.stringify(crm)); renderCRM();
  });
  tbody.querySelectorAll(".del").forEach(b=> b.onclick = (e)=>{
    const id=e.target.getAttribute("data-id");
    crm = crm.filter(x=>x.id!==id); localStorage.setItem(LS.CRM, JSON.stringify(crm)); renderCRM();
  });
}
function renderAnalytics(){
  setText("aLeads", crm.length);
  let preco=0, consumo=0, espaco=0;
  crm.forEach(L=> (L.transcript||[]).forEach(m=>{
    const t=(m.text||"").toLowerCase();
    if (t.includes("pre√ßo")||t.includes("preco")||t.includes("caro")) preco++;
    if (t.includes("consumo")) consumo++;
    if (t.includes("espa√ßo")||t.includes("espaco")||t.includes("porta-malas")) espaco++;
  }));
  setText("aPreco", preco); setText("aConsumo", consumo); setText("aEspaco", espaco);
  const ul=document.getElementById("followups"); ul.innerHTML="";
  crm.filter(L=>L.next_followup_at).sort((a,b)=> new Date(a.next_followup_at)-new Date(b.next_followup_at)).slice(0,10).forEach(L=>{
    const li=document.createElement("li"); li.textContent = `${sanitize(L.name)||"Lead"} ‚Ä¢ ${new Date(L.next_followup_at).toLocaleString()} ‚Ä¢ ${sanitize(L.followup_note||"")}`; ul.appendChild(li);
  });
}
function setText(id,val){ const el=document.getElementById(id); if(el) el.textContent=val; }

/* ================== EXPORT / CLEAR ================== */
function exportCsv(){
  const headers=["id","status","name","phone","email","new_or_used","model_hint","budget_cash","budget_month","use_case","annual_km","priorities","suggested_prios","recommendations","fuel","gearbox","cep","score","next_followup_at","followup_note","created_at","updated_at"];
  const rows=[headers.join(",")];
  crm.forEach(L=>{
    const row=headers.map(h=>{
      const v=(h==="priorities")? (L.priorities||[]).join("|")
        : (h==="suggested_prios")? (L.suggested_prios||[]).join("|")
        : (h==="recommendations")? (L.recommendations||[]).map(r=>`${r.model}:${r.price}`).join("|")
        : (L[h]??"");
      return `"${String(v).replace(/"/g,'""')}"`;
    }).join(",");
    rows.push(row);
  });
  const blob=new Blob([rows.join("\n")],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="crm.csv"; a.click(); URL.revokeObjectURL(url);
}
function clearCrm(){
  if (!confirm("Apagar todos os leads do CRM (local)?")) return;
  crm=[]; localStorage.setItem(LS.CRM, JSON.stringify(crm)); renderCRM();
}

/* ================== BOOT ================== */
function boot(){
  document.querySelector('.tab[data-tab="chat"]').click();
  onNewLead();
  loadPromptEditor();
  loadQuestionsEditor();
  renderTags();
}
boot();
</script>
</body>
</html>
