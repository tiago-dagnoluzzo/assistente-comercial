<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Consultor de Autom√≥veis ‚Äî Demo P√∫blica (IA via Proxy)</title>
<style>
:root{
  --bg:#0b1020; --panel:#0f172a; --muted:#93adc4; --text:#e6eef7; --border:#1f2a44;
  --accent:#00E0A4; --accent-2:#66E8FF;
}
*{box-sizing:border-box} html,body{margin:0;height:100%}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
  background:radial-gradient(1100px 600px at -10% -10%, rgba(0,224,164,.12), transparent 60%),
             radial-gradient(1200px 800px at 110% -10%, rgba(102,232,255,.12), transparent 60%), var(--bg);
  color:var(--text)}
a{color:var(--accent)}
.header{position:sticky;top:0;z-index:50;background:rgba(11,16,32,.72);backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid var(--border)}
.max{max-width:1200px;margin:0 auto;padding:14px 20px}
.nav{display:flex;align-items:center;gap:14px}
.brand{display:flex;align-items:center;gap:10px}
.brand .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(145deg,var(--accent),var(--accent-2));display:grid;place-items:center;color:#0b1020;font-weight:800}
.brand .name{font-weight:700}
.nav .spacer{flex:1}
.hero{max-width:1200px;margin:0 auto;padding:26px 20px 10px}
.hero .wrap{display:grid;grid-template-columns:1.1fr .9fr;gap:24px;align-items:center}
.h1{font-size:28px;margin:0 0 8px} .sub{color:var(--muted);margin:0 0 16px}
.cta{display:flex;gap:8px;flex-wrap:wrap}
.btn{border:1px solid var(--border);background:linear-gradient(145deg,var(--accent),var(--accent-2));color:#08202a;font-weight:700;padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:0 6px 20px -8px rgba(0,224,164,.45)}
.btn.secondary{background:transparent;color:var(--text)}
.preview{background:rgba(16,24,48,.6);border:1px solid var(--border);border-radius:16px;padding:14px}
.small{color:var(--muted);font-size:12px}
.tabs{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.tab{background:#0e152b;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
.tab.active{background:linear-gradient(145deg,var(--accent),var(--accent-2));color:#0b1020;border-color:transparent;font-weight:700}
main{max-width:1200px;margin:0 auto;padding:12px 20px 40px}
.grid{display:grid;grid-template-columns:360px 1fr;gap:18px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
h3{margin:0 0 10px}
.input, textarea, select, input[type="color"]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b1224;color:var(--text)}
label{display:block;margin-bottom:6px;color:var(--muted)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0d1430;color:#8bf3ff;font-size:12px}
.messages{height:56vh;overflow:auto;display:flex;flex-direction:column;gap:10px;padding-right:4px}
.msg{max-width:78%;padding:10px 12px;border-radius:12px;line-height:1.35;white-space:pre-wrap}
.msg.bot{align-self:flex-start;background:#0d162e;border:1px solid var(--border)}
.msg.user{align-self:flex-end;background:rgba(0,224,164,.12);border:1px solid rgba(0,224,164,.42)}
.composer{display:flex;gap:8px;margin-top:8px} .composer input{flex:1}
.table-wrap{overflow:auto} table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
.kpi{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
.kpi-number{font-size:26px;font-weight:700}
.hidden{display:none !important}
.switch{display:flex;align-items:center;gap:8px}
select.provider{background:#0d1430;border-color:#25406b}
</style>
</head>
<body>
<header class="header">
  <div class="max nav">
    <div class="brand">
      <div class="logo">üöó</div>
      <div class="name">Consultor de Autom√≥veis</div>
      <span class="badge">Demo com IA</span>
    </div>
    <div class="spacer"></div>
    <div class="switch">
      <input type="checkbox" id="useAI"/>
      <label for="useAI">Usar IA (proxy p√∫blico)</label>
    </div>
  </div>
</header>

<section class="hero" id="home">
  <div class="wrap">
    <div>
      <h1 class="h1">Recomenda√ß√£o de carro, TCO e seguro ‚Äî com IA via proxies p√∫blicos</h1>
      <p class="sub">Ative a IA e aponte para sua fun√ß√£o Vercel: <code>/api/chat_gemini</code> (Google AI Studio ‚Äî free tier) ou <code>/api/chat_mistral</code> (free limitado). Sem expor chaves no navegador.</p>
      <div class="cta">
        <a class="btn" href="#demo">Come√ßar a demo</a>
        <a class="btn secondary" href="#trainer">Treinar scripts</a>
      </div>
      <p class="small">Dica: configure abaixo a <strong>URL do Proxy</strong> e selecione o <strong>provedor</strong>.</p>
    </div>
    <div class="preview">
      <div class="row">
        <span class="badge">Hatch</span>
        <span class="badge">Sedan</span>
        <span class="badge">SUV</span>
        <span class="badge">Picape</span>
      </div>
      <p class="small" style="margin-top:8px">UI single-file. Dados locais. IA via proxy seguro seu.</p>
    </div>
  </div>
</section>

<div class="max">
  <div class="tabs" id="tabs">
    <button class="tab active" data-tab="demo">Demo (Chat)</button>
    <button class="tab" data-tab="crm">CRM</button>
    <button class="tab" data-tab="analytics">Analytics</button>
    <button class="tab" data-tab="trainer">Treinar scripts</button>
    <button class="tab" data-tab="personalizar">Personalizar</button>
    <button class="tab" data-tab="sobre">Sobre</button>
  </div>
</div>

<main class="max">
  <!-- Demo -->
  <section id="demo" class="tab-content">
    <div class="grid">
      <aside class="card">
        <h3>Lead atual</h3>
        <div id="leadSnapshot"><p class="small">Nenhum lead ainda.</p></div>
        <div class="row" style="margin-top:8px">
          <button class="btn secondary" id="btnSaveLead">Salvar lead</button>
          <button class="btn secondary" id="btnSchedule">Agendar contato (.ics)</button>
          <button class="btn secondary" id="btnNewLead">Novo lead</button>
        </div>
        <hr/>
        <label>Provedor</label>
        <select id="provider" class="input provider">
          <option value="gemini">Gemini (free tier)</option>
          <option value="mistral">Mistral (free limitado)</option>
        </select>
        <label style="margin-top:10px">URL base do seu projeto Vercel (sem /api)</label>
        <input id="baseUrl" class="input" placeholder="https://SEU-PROJ.vercel.app"/>
        <label style="margin-top:10px">Endpoint completo (preenchido automaticamente)</label>
        <input id="proxyUrl" class="input" placeholder="https://SEU-PROJ.vercel.app/api/chat_gemini"/>
        <p class="small">
          ‚Ä¢ Gemini: defina <code>GEMINI_API_KEY</code> nas vars do Vercel e use <code>/api/chat_gemini</code>.<br/>
          ‚Ä¢ Mistral: defina <code>MISTRAL_API_KEY</code> e use <code>/api/chat_mistral</code>.
        </p>
        <div class="row">
          <button class="btn secondary" id="btnTest">Testar endpoint</button>
          <span class="small" id="endpointStatus"></span>
        </div>
      </aside>
      <div class="card">
        <div id="messages" class="messages"></div>
        <div class="composer">
          <input id="userInput" class="input" placeholder="Escreva aqui... (ex.: Preciso de um carro econ√¥mico para fam√≠lia de 4)"/>
          <button class="btn" id="sendBtn">Enviar</button>
        </div>
      </div>
    </div>
  </section>

  <!-- CRM -->
  <section id="crm" class="tab-content hidden">
    <div class="kpis">
      <div class="kpi"><div class="kpi-number" id="kpiLeads">0</div><div>Leads</div></div>
      <div class="kpi"><div class="kpi-number" id="kpiQual">0</div><div>Qualificados</div></div>
      <div class="kpi"><div class="kpi-number" id="kpiQuote">0</div><div>Recomenda√ß√£o enviada</div></div>
      <div class="kpi"><div class="kpi-number" id="kpiWon">0</div><div>Fechados</div></div>
    </div>
    <div class="card">
      <div class="row" style="margin-bottom:10px">
        <input class="input" id="search" placeholder="Buscar por nome, telefone, prioridade, status..."/>
        <button class="btn secondary" id="exportCsv">Exportar CSV</button>
        <button class="btn secondary" id="clearCrm">Limpar CRM</button>
      </div>
      <div class="table-wrap">
        <table id="crmTable">
          <thead><tr><th>Status</th><th>Nome</th><th>Perfil</th><th>Tel</th><th>Score</th><th>Atualizado</th><th>A√ß√µes</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Analytics -->
  <section id="analytics" class="tab-content hidden">
    <div class="card">
      <h3>Vis√£o geral</h3>
      <div class="kpis">
        <div class="kpi"><div class="kpi-number" id="aLeads">0</div><div>Leads</div></div>
        <div class="kpi"><div class="kpi-number" id="aObjPreco">0</div><div>Obje√ß√µes: pre√ßo</div></div>
        <div class="kpi"><div class="kpi-number" id="aObjConsumo">0</div><div>Prioridade: consumo</div></div>
        <div class="kpi"><div class="kpi-number" id="aObjEspaco">0</div><div>Prioridade: espa√ßo</div></div>
      </div>
      <h3>Pr√≥ximos follow-ups</h3>
      <ul id="followups"></ul>
    </div>
  </section>

  <!-- Trainer -->
  <section id="trainer" class="tab-content hidden">
    <div class="card">
      <h3>Treinar scripts (Consultor de Autom√≥veis)</h3>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <label>Sauda√ß√£o / Abertura</label>
          <textarea id="tGreeting" rows="4" class="input">Ol√°! Sou seu consultor de autom√≥veis. Vou te ajudar a escolher o carro ideal considerando or√ßamento, uso e custo total (TCO), sem enrola√ß√£o.</textarea>
        </div>
        <div>
          <label>Fechamento / Pr√≥ximo passo</label>
          <textarea id="tClosing" rows="4" class="input">Te envio 2‚Äì3 op√ß√µes com pr√≥s/contras, consumo, seguro estimado e manuten√ß√£o. Me passe seu nome e telefone para eu formalizar a proposta e te chamar no WhatsApp.</textarea>
        </div>
        <div>
          <label>Perguntas de Descoberta (uma por linha)</label>
          <textarea id="tDiscovery" rows="8" class="input">Carro novo ou usado? Algum modelo/ano em mente?
Qual √© seu or√ßamento (√† vista ou parcela mensal)?
Uso principal (cidade/rodovia/app/fam√≠lia)? Quilometragem/ano?
Prioridades (consumo, conforto, tecnologia, desempenho, espa√ßo, seguran√ßa)?
Combust√≠vel preferido (flex/h√≠brido/el√©trico)? C√¢mbio (manual/autom√°tico)?
CEP para estimar seguro/IPVA?
Tem carro para troca?</textarea>
        </div>
        <div>
          <label>Tratamento de Obje√ß√µes (JSON)</label>
          <textarea id="tObjections" rows="8" class="input">{
  "preco": "Se o valor ficou alto, eu monto op√ß√µes com ano/modelo alternativos, ou vers√µes com menos itens para manter seguran√ßa e reduzir custo.",
  "consumo": "Posso priorizar carros com consumo menor (h√≠bridos/flex econ√¥micos) e calcular payback vs. op√ß√µes mais potentes.",
  "manutencao": "Trago estimativa anual de manuten√ß√£o e disponibilidade de pe√ßas para cada modelo.",
  "seguro": "Incluo uma estimativa de seguro com base no perfil/CEP e mostro como isso afeta o custo mensal.",
  "espaco": "Avalio porta-malas, espa√ßo traseiro e isofix. Se fam√≠lia crescer, mostro SUVs compactos x sedans espa√ßosos.",
  "depreciacao": "Mostro deprecia√ß√£o m√©dia em 3 e 5 anos e como isso influencia o TCO."
}</textarea>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnSaveTraining">Salvar</button>
        <button class="btn secondary" id="btnClearTraining">Restaurar padr√£o</button>
        <button class="btn secondary" id="btnExportConfig">Exportar configura√ß√£o (.json)</button>
        <input type="file" id="importFile" class="hidden" accept=".json"/>
        <button class="btn secondary" id="btnImportConfig">Importar configura√ß√£o</button>
      </div>
    </div>
  </section>

  <!-- Personalizar -->
  <section id="personalizar" class="tab-content hidden">
    <div class="card">
      <h3>Branding & Tema</h3>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <label>Nome do consultor</label>
          <input id="sAgent" class="input" placeholder="Tiago"/>
          <label style="margin-top:10px">Nome do neg√≥cio</label>
          <input id="sBiz" class="input" placeholder="Consultoria Auto Tiago"/>
          <label style="margin-top:10px">Follow-up (min) ‚Äî demo</label>
          <input id="sFollow" class="input" type="number" min="1" max="60" value="3"/>
        </div>
        <div>
          <div class="row" style="margin-top:10px">
            <div>
              <label>Cor prim√°ria</label>
              <input type="color" id="cPrimary" value="#00E0A4"/>
            </div>
            <div>
              <label>Cor secund√°ria</label>
              <input type="color" id="cSecondary" value="#66E8FF"/>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnSaveTheme">Salvar tema</button>
            <button class="btn secondary" id="btnResetTheme">Restaurar tema</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Sobre -->
  <section id="sobre" class="tab-content hidden">
    <div class="card">
      <h3>Sobre esta demo</h3>
      <p>Ative ‚ÄúUsar IA (proxy p√∫blico)‚Äù e aponte para sua fun√ß√£o Vercel/Netlify/Cloudflare que chama <b>Gemini</b> (AI Studio) ou <b>Mistral</b>. Suas chaves ficam seguras no servidor.</p>
      <ul>
        <li><strong>Single file:</strong> publique como site est√°tico e compartilhe.</li>
        <li><strong>Privado:</strong> dados ficam no navegador; a chamada de IA passa pelo seu proxy.</li>
        <li><strong>Treino:</strong> ‚ÄúTreinar scripts‚Äù controla tom, perguntas e obje√ß√µes.</li>
      </ul>
    </div>
  </section>
</main>

<script>
// ===== Storage & Defaults =====
const LS = { SETTINGS:"auto_settings", TRAINING:"auto_training", CRM:"auto_crm", THEME:"auto_theme" };
const defaults = {
  settings: { agent:"Tiago", biz:"Consultoria Auto Tiago", follow:3, baseUrl:"", provider:"gemini" },
  training: {
    greeting: "Ol√°! Sou seu consultor de autom√≥veis. Vou te ajudar a escolher o carro ideal considerando or√ßamento, uso e custo total (TCO), sem enrola√ß√£o.",
    discovery: [
      "Carro novo ou usado? Algum modelo/ano em mente?",
      "Qual √© seu or√ßamento (√† vista ou parcela mensal)?",
      "Uso principal (cidade/rodovia/app/fam√≠lia)? Quilometragem/ano?",
      "Prioridades (consumo, conforto, tecnologia, desempenho, espa√ßo, seguran√ßa)?",
      "Combust√≠vel preferido (flex/h√≠brido/el√©ctrico)? C√¢mbio (manual/autom√°tico)?",
      "CEP para estimar seguro/IPVA?",
      "Tem carro para troca?"
    ],
    objections: {
      preco: "Se o valor ficou alto, eu monto op√ß√µes com ano/modelo alternativos, ou vers√µes com menos itens para manter seguran√ßa e reduzir custo.",
      consumo: "Posso priorizar carros com consumo menor (h√≠bridos/flex econ√¥micos) e calcular payback vs. op√ß√µes mais potentes.",
      manutencao: "Trago estimativa anual de manuten√ß√£o e disponibilidade de pe√ßas para cada modelo.",
      seguro: "Incluo uma estimativa de seguro com base no perfil/CEP e mostro como isso afeta o custo mensal.",
      espaco: "Avalio porta-malas, espa√ßo traseiro e isofix. Se fam√≠lia crescer, mostro SUVs compactos x sedans espa√ßosos.",
      depreciacao: "Mostro deprecia√ß√£o m√©dia em 3 e 5 anos e como isso influencia o TCO."
    },
    closing: "Te envio 2‚Äì3 op√ß√µes com pr√≥s/contras, consumo, seguro estimado e manuten√ß√£o. Me passe seu nome e telefone para eu formalizar a proposta e te chamar no WhatsApp."
  },
  theme: { accent:"#00E0A4", accent2:"#66E8FF" }
};
let settings = JSON.parse(localStorage.getItem(LS.SETTINGS)||"null") || defaults.settings;
let training = JSON.parse(localStorage.getItem(LS.TRAINING)||"null") || defaults.training;
let crm = JSON.parse(localStorage.getItem(LS.CRM)||"null") || [];
let theme = JSON.parse(localStorage.getItem(LS.THEME)||"null") || defaults.theme;

// ===== Tabs =====
const tabs = document.querySelectorAll(".tab");
const sections = document.querySelectorAll(".tab-content");
tabs.forEach(b=> b.addEventListener("click", ()=>{
  tabs.forEach(x=>x.classList.remove("active"));
  sections.forEach(s=>s.classList.add("hidden"));
  b.classList.add("active");
  document.getElementById(b.dataset.tab).classList.remove("hidden");
  if (b.dataset.tab === "crm") renderCRM();
  if (b.dataset.tab === "analytics") renderAnalytics();
  if (b.dataset.tab === "trainer") loadTrainer();
  if (b.dataset.tab === "personalizar") loadPersonalize();
}));

// ===== Theme & Branding =====
function applyTheme(){
  document.documentElement.style.setProperty("--accent", theme.accent);
  document.documentElement.style.setProperty("--accent-2", theme.accent2);
}
function loadPersonalize(){
  document.getElementById("sAgent").value = settings.agent;
  document.getElementById("sBiz").value = settings.biz;
  document.getElementById("sFollow").value = settings.follow;
  document.getElementById("proxyUrl").value = buildEndpoint();
  document.getElementById("provider").value = settings.provider || "gemini";
  document.getElementById("baseUrl").value = settings.baseUrl || "";
}
document.getElementById("btnSaveTheme").onclick = ()=>{
  settings.agent = document.getElementById("sAgent").value || "Tiago";
  settings.biz = document.getElementById("sBiz").value || "Consultoria Auto Tiago";
  settings.follow = parseInt(document.getElementById("sFollow").value||"3",10);
  localStorage.setItem(LS.SETTINGS, JSON.stringify(settings));
  applyTheme();
  alert("Tema e branding salvos.");
};
document.getElementById("btnResetTheme").onclick = ()=>{
  settings = JSON.parse(JSON.stringify(defaults.settings));
  theme = JSON.parse(JSON.stringify(defaults.theme));
  localStorage.setItem(LS.SETTINGS, JSON.stringify(settings));
  localStorage.setItem(LS.THEME, JSON.stringify(theme));
  loadPersonalize(); applyTheme(); alert("Tema restaurado.");
};

// ===== Provider & Endpoint helpers =====
const providerEl = document.getElementById("provider");
const baseUrlEl = document.getElementById("baseUrl");
const proxyUrlEl = document.getElementById("proxyUrl");
providerEl.addEventListener("change", ()=> proxyUrlEl.value = buildEndpoint());
baseUrlEl.addEventListener("input", ()=> proxyUrlEl.value = buildEndpoint());

function buildEndpoint(){
  const base = (baseUrlEl.value || settings.baseUrl || "").trim().replace(/\/+$/,"");
  const prov = (providerEl.value || settings.provider || "gemini");
  return base ? base + (prov==="gemini"?"/api/chat_gemini":"/api/chat_mistral") : "";
}

// ===== Chat =====
const messagesEl = document.getElementById("messages");
const useAIEl = document.getElementById("useAI");
useAIEl.checked = !!settings.baseUrl;
function appendMsg(sender, text){
  const div = document.createElement("div"); div.className = "msg " + (sender === "bot" ? "bot" : "user"); div.textContent = text;
  messagesEl.appendChild(div); messagesEl.scrollTop = messagesEl.scrollHeight;
}
function bot(t){ appendMsg("bot", t); currentLead.transcript.push({who:settings.agent, text:t, ts:new Date().toISOString()}); }
function user(t){ appendMsg("user", t); currentLead.transcript.push({who:"Cliente", text:t, ts:new Date().toISOString()}); }

let currentLead = newLead();
let chatState = { started:false, step:0 };
function newLead(){
  return {
    id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
    name:"", phone:"", email:"", status:"Novo", score:0,
    budget_month:"", budget_cash:"", new_or_used:"", model_hint:"",
    use_case:"", annual_km:"", priorities:[], fuel:"", gearbox:"", cep:"", trade_in:"",
    rec_summary:"", timeframe:"",
    created_at:new Date().toISOString(), updated_at:new Date().toISOString(),
    transcript:[]
  };
}
function start(){ bot(`${training.greeting}\nPara come√ßar, diga se pensa em carro novo ou usado ‚Äî e se tem algum modelo/ano em mente.`); }
const userInput = document.getElementById("userInput");
document.getElementById("sendBtn").onclick = handleSend;
userInput.addEventListener("keydown", e=> (e.key==="Enter") && handleSend());

async function handleSend(){
  const t = userInput.value.trim(); if (!t) return; userInput.value = "";
  user(t);
  if (!chatState.started){ chatState.started = true; ask1(); return; }
  if (useAIEl.checked && proxyUrlEl.value){
    try{
      // Atualiza settings com UI atual
      settings.baseUrl = baseUrlEl.value.trim();
      settings.provider = providerEl.value;
      localStorage.setItem(LS.SETTINGS, JSON.stringify(settings));

      const sys = buildSystemPrompt();
      const payload = { system: sys, messages: currentLead.transcript.slice(-20) };
      const res = await fetch(buildEndpoint(), { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error("Falha no proxy ("+res.status+")");
      const data = await res.json();
      bot(data.text || "(sem resposta)");
      updateLeadSnapshot();
      return;
    }catch(e){
      bot("N√£o consegui falar com a IA agora. Vou seguir o fluxo offline. ("+e.message+")");
    }
  }
  processOffline(t);
}

function buildSystemPrompt(){
  return `Voc√™ √© um consultor de autom√≥veis. Foque em entender o perfil do cliente e sugerir 2‚Äì3 modelos com pr√≥s/contras, consumo, manuten√ß√£o, deprecia√ß√£o, seguro estimado e TCO resumido.
Sauda√ß√£o: ${training.greeting}
Perguntas (ordem sugerida): ${training.discovery.join(" | ")}
Obje√ß√µes: ${JSON.stringify(training.objections)}
Fechamento: ${training.closing}
Sempre que fizer sentido, pe√ßa nome e telefone para formalizar a proposta.`;
}

// ===== Offline flow (consultoria de autom√≥veis) =====
function includesAny(text, arr){ const l=text.toLowerCase(); return arr.some(k=> l.includes(k.toLowerCase())); }
function extractNum(text){ const m=text.match(/\d+/g); return m? m.join("") : ""; }
function ask1(){ bot("Carro novo ou usado? Algum modelo/ano em mente?"); chatState.step=1; }
function ask2(){ bot("Qual or√ßamento? Pode ser √† vista (R$) ou parcela mensal. Se tiver entrada, diga quanto."); chatState.step=2; }
function ask3(){ bot("Uso principal (cidade/rodovia/app/fam√≠lia)? E sua quilometragem aproximada por ano?"); chatState.step=3; }
function ask4(){ bot("Quais prioridades voc√™ valoriza? (ex.: consumo, conforto, tecnologia, desempenho, espa√ßo, seguran√ßa)"); chatState.step=4; }
function ask5(){ bot("Prefer√™ncia de combust√≠vel (flex/h√≠brido/el√©ctrico) e c√¢mbio (manual/autom√°tico)? Informe tamb√©m seu CEP para estimar seguro/IPVA."); chatState.step=5; }
function ask6(){ bot("Tem carro para troca? E me passe seu nome e telefone (ex.: Maria 41999998888) para eu formalizar as recomenda√ß√µes."); chatState.step=6; }

function processOffline(text){
  switch(chatState.step){
    case 1:
      currentLead.new_or_used = includesAny(text,["novo","zero"])?"Novo":(includesAny(text,["usado","semi"]))?"Usado":(currentLead.new_or_used||"");
      if (!currentLead.model_hint) currentLead.model_hint = text;
      ask2(); break;
    case 2:
      if (!currentLead.budget_cash && text.includes("√† vista")||text.includes("a vista")) currentLead.budget_cash = extractNum(text);
      if (!currentLead.budget_month && includesAny(text,["parcela","mensal","m√™s","mes"])) currentLead.budget_month = extractNum(text);
      if (!currentLead.budget_cash && !currentLead.budget_month) currentLead.budget_month = extractNum(text);
      ask3(); break;
    case 3:
      if (!currentLead.use_case) currentLead.use_case = text;
      if (!currentLead.annual_km) currentLead.annual_km = extractNum(text);
      ask4(); break;
    case 4:
      currentLead.priorities = text.split(/,|;|\/|\s\|\s/).map(s=>s.trim()).filter(Boolean);
      ask5(); break;
    case 5:
      if (!currentLead.fuel) currentLead.fuel = includesAny(text,["h√≠brido","hibrido"])?"H√≠brido":includesAny(text,["el√©trico","eletrico"])?"El√©trico": includesAny(text,["flex"])?"Flex":"";
      if (!currentLead.gearbox) currentLead.gearbox = includesAny(text,["autom√°tico","automatico"])?"Autom√°tico": includesAny(text,["manual"])?"Manual":"";
      if (!currentLead.cep) currentLead.cep = extractNum(text);
      ask6(); break;
    case 6:
      if (!currentLead.name || !currentLead.phone){
        const m = text.match(/(\+?\d{10,14})/); currentLead.phone = m? m[0] : ""; currentLead.name = m? text.replace(m[0],"").trim(): text.trim();
        currentLead.status="Qualificado"; currentLead.score = scoreLead(currentLead);
        bot(training.closing); updateLeadSnapshot(); break;
      }
      if (!currentLead.timeframe){ currentLead.timeframe=text; currentLead.status="Recomenda√ß√£o enviada"; updateLeadSnapshot(); }
      break;
  }
}

function scoreLead(L){
  let s=0;
  if (L.new_or_used) s+=10;
  if (L.budget_month || L.budget_cash) s+=20;
  if (L.use_case) s+=10;
  if (L.annual_km) s+=10;
  if ((L.priorities||[]).length) s+=10;
  if (L.fuel || L.gearbox) s+=10;
  if (L.cep) s+=10;
  if (L.name) s+=10;
  if (L.phone && L.phone.length>=10) s+=10;
  return Math.min(100,s);
}
function updateLeadSnapshot(){
  const L=currentLead;
  document.getElementById("leadSnapshot").innerHTML = `
    <div class="badge">${L.status}</div>
    <p><strong>${L.name||"(sem nome)"}</strong> ‚Ä¢ Score ${L.score}</p>
    <p>${L.new_or_used||"-"} ‚Ä¢ ${L.model_hint||"-"}</p>
    <p>Or√ßamento: √† vista R$ ${L.budget_cash||"-"} ‚Ä¢ mensal R$ ${L.budget_month||"-"}</p>
    <p>Uso: ${L.use_case||"-"} ‚Ä¢ km/ano: ${L.annual_km||"-"} ‚Ä¢ CEP: ${L.cep||"-"}</p>
    <p>Prefer√™ncias: ${L.priorities?.join(", ")||"-"} ‚Ä¢ ${L.fuel||"-"} ‚Ä¢ ${L.gearbox||"-"}</p>
  `;
}

// ===== CRM & Analytics =====
document.getElementById("btnSaveLead").onclick = ()=>{
  const i = crm.findIndex(x=>x.id===currentLead.id);
  if (i>=0) crm[i]=currentLead; else crm.push(currentLead);
  currentLead.updated_at = new Date().toISOString();
  localStorage.setItem(LS.CRM, JSON.stringify(crm));
  renderCRM(); alert("Lead salvo no CRM.");
};
document.getElementById("btnNewLead").onclick = ()=>{
  currentLead = newLead(); chatState = { started:false, step:0 };
  document.getElementById("messages").innerHTML = ""; start();
};
document.getElementById("btnSchedule").onclick = ()=>{
  const ics = generateICS(currentLead);
  const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
  const url = URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download="followup.ics"; a.click(); URL.revokeObjectURL(url);
};
function generateICS(L){
  const dt=new Date(Date.now()+24*60*60*1000);
  const pad=n=>String(n).padStart(2,"0");
  const stamp = dt.getUTCFullYear()+pad(dt.getUTCMonth()+1)+pad(dt.getUTCDate())+"T"+pad(dt.getUTCHours())+pad(dt.getUTCMinutes())+"00Z";
  return `BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
UID:${L.id}@consultor.auto
DTSTAMP:${stamp}
DTSTART:${stamp}
DURATION:PT30M
SUMMARY:Follow-up recomenda√ß√£o de carro ‚Ä¢ ${L.name||"Lead"}
DESCRIPTION:Contato com ${L.name||"Lead"} - Tel ${L.phone||"-"}
END:VEVENT
END:VCALENDAR`;
}
function renderCRM(){
  const tbody=document.querySelector("#crmTable tbody");
  const q=(document.getElementById("search").value||"").toLowerCase();
  const list=crm.filter(L=> !q || (`${L.name} ${L.phone} ${L.use_case} ${L.status} ${L.priorities?.join(" ")}`).toLowerCase().includes(q));
  document.getElementById("kpiLeads").textContent=crm.length;
  document.getElementById("kpiQual").textContent=crm.filter(x=>x.status==="Qualificado").length;
  document.getElementById("kpiQuote").textContent=crm.filter(x=>x.status==="Recomenda√ß√£o enviada").length;
  document.getElementById("kpiWon").textContent=crm.filter(x=>x.status==="Fechado").length;
  tbody.innerHTML="";
  list.forEach(L=>{
    const tr=document.createElement("tr");
    const perfil = `${L.new_or_used||"-"} | ${L.model_hint||"-"} | ${L.priorities?.slice(0,2).join("/")||"-"}`;
    tr.innerHTML=`<td><span class="badge">${L.status}</span></td>
      <td>${L.name||"-"}</td><td>${perfil}</td><td>${L.phone||"-"}</td>
      <td>${L.score||0}</td><td>${new Date(L.updated_at||L.created_at).toLocaleString()}</td>
      <td><button class="btn secondary open" data-id="${L.id}">Abrir</button> <button class="btn secondary stage" data-id="${L.id}">Avan√ßar</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll(".open").forEach(b=> b.onclick = (e)=>{
    const id=e.target.getAttribute("data-id"); const L=crm.find(x=>x.id===id); if(!L) return;
    currentLead=JSON.parse(JSON.stringify(L));
    document.querySelector('.tab[data-tab="demo"]').click();
    bot("Lead reaberto no chat."); updateLeadSnapshot();
  });
  tbody.querySelectorAll(".stage").forEach(b=> b.onclick = (e)=>{
    const id=e.target.getAttribute("data-id"); const L=crm.find(x=>x.id===id); if(!L) return;
    const order=["Novo","Qualificado","Recomenda√ß√£o enviada","Fechamento","Fechado"];
    const i=order.indexOf(L.status); L.status=order[Math.min(order.length-1,i+1)]||"Qualificado";
    L.updated_at=new Date().toISOString(); localStorage.setItem(LS.CRM, JSON.stringify(crm)); renderCRM();
  });
}
document.getElementById("search").oninput = renderCRM;
document.getElementById("exportCsv").onclick = ()=>{
  const headers=["id","status","name","phone","new_or_used","model_hint","budget_cash","budget_month","use_case","annual_km","priorities","fuel","gearbox","cep","timeframe","score","created_at","updated_at"];
  const rows=[headers.join(",")];
  crm.forEach(L=> rows.push(headers.map(h=>`"${String((h==="priorities"? (L[h]||[]).join("|") : L[h]) ??"").replace(/"/g,'""')}"`).join(",")));
  const blob=new Blob([rows.join("\n")],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="crm.csv"; a.click(); URL.revokeObjectURL(url);
};
document.getElementById("clearCrm").onclick = ()=>{
  if (!confirm("Apagar todos os leads do CRM?")) return;
  crm=[]; localStorage.setItem(LS.CRM, JSON.stringify(crm)); renderCRM();
};

function renderAnalytics(){
  document.getElementById("aLeads").textContent = crm.length;
  let preco=0, consumo=0, espaco=0;
  crm.forEach(L=> (L.transcript||[]).forEach(m=>{
    const t=(m.text||"").toLowerCase();
    if (t.includes("pre√ßo")||t.includes("preco")||t.includes("caro")) preco++;
    if (t.includes("consumo")) consumo++;
    if (t.includes("espa√ßo")||t.includes("espaco")||t.includes("porta-malas")||t.includes("portamalas")) espaco++;
  }));
  document.getElementById("aObjPreco").textContent = preco;
  document.getElementById("aObjConsumo").textContent = consumo;
  document.getElementById("aObjEspaco").textContent = espaco;
  const ul=document.getElementById("followups"); ul.innerHTML="";
  crm.slice().sort((a,b)=> new Date(a.updated_at||a.created_at)-new Date(b.updated_at||b.created_at)).slice(0,5).forEach(L=>{
    const li=document.createElement("li"); li.textContent = `${L.name||"Lead"} ‚Ä¢ ${L.model_hint||"-"} ‚Ä¢ ${new Date(L.updated_at||L.created_at).toLocaleString()}`; ul.appendChild(li);
  });
}

// Trainer
function loadTrainer(){
  document.getElementById("tGreeting").value = training.greeting || "";
  document.getElementById("tDiscovery").value = (training.discovery||[]).join("\n");
  document.getElementById("tObjections").value = JSON.stringify(training.objections||{}, null, 2);
  document.getElementById("tClosing").value = training.closing || "";
}
document.getElementById("btnSaveTraining").onclick = ()=>{
  try{
    const obj = JSON.parse(document.getElementById("tObjections").value || "{}");
    training = {
      greeting: document.getElementById("tGreeting").value || defaults.training.greeting,
      discovery: (document.getElementById("tDiscovery").value||"").split("\n").filter(Boolean),
      objections: obj,
      closing: document.getElementById("tClosing").value || defaults.training.closing
    };
    localStorage.setItem(LS.TRAINING, JSON.stringify(training));
    alert("Treinamento salvo!");
  }catch(e){ alert("JSON de obje√ß√µes inv√°lido."); }
};
document.getElementById("btnClearTraining").onclick = ()=>{
  training = JSON.parse(JSON.stringify(defaults.training));
  localStorage.setItem(LS.TRAINING, JSON.stringify(training));
  loadTrainer(); alert("Treinamento restaurado.");
};
document.getElementById("btnExportConfig").onclick = ()=>{
  const data = { settings, training, theme };
  const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="consultor-auto-config.json"; a.click(); URL.revokeObjectURL(url);
};
document.getElementById("btnImportConfig").onclick = ()=> document.getElementById("importFile").click();
document.getElementById("importFile").addEventListener("change",(e)=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const data = JSON.parse(reader.result);
      if (data.settings) { settings = data.settings; localStorage.setItem(LS.SETTINGS, JSON.stringify(settings)); }
      if (data.training) { training = data.training; localStorage.setItem(LS.TRAINING, JSON.stringify(training)); }
      if (data.theme) { theme = data.theme; localStorage.setItem(LS.THEME, JSON.stringify(theme)); applyTheme(); }
      loadTrainer(); loadPersonalize(); alert("Configura√ß√£o importada!");
    }catch(e){ alert("Arquivo inv√°lido."); }
  };
  reader.readAsText(file);
});

// ===== Endpoint tester =====
document.getElementById("btnTest").onclick = async ()=>{
  const url = buildEndpoint();
  document.getElementById("proxyUrl").value = url;
  if(!url){ document.getElementById("endpointStatus").textContent = "Informe base URL e provedor."; return; }
  document.getElementById("endpointStatus").textContent = "Testando...";
  try{
    const r = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ system:"Teste", messages:[{who:"Cliente", text:"Ol√°"}] })
    });
    document.getElementById("endpointStatus").textContent = "Status: " + r.status;
  }catch(e){
    document.getElementById("endpointStatus").textContent = "Falha: " + e.message;
  }
};

// Boot
function boot(){
  applyTheme();
  document.querySelector('.tab[data-tab="demo"]').click();
  document.getElementById("provider").value = settings.provider || "gemini";
  document.getElementById("baseUrl").value = settings.baseUrl || "";
  document.getElementById("proxyUrl").value = buildEndpoint();
  setTimeout(()=>{
    bot(`Ol√°! Eu sou ${settings.agent} da ${settings.biz}.`);
    bot("Diga se prefere carro novo ou usado e me conte seu or√ßamento e uso. Eu te retorno com 2‚Äì3 op√ß√µes.");
  }, 250);
}
boot();
</script>
</body>
</html>
