<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Consultor de Autom√≥veis ‚Äî IA (Gemini Prompt Editor)</title>
<style>
:root{
  --bg:#0b1020; --panel:#0f172a; --muted:#93adc4; --text:#e6eef7; --border:#1f2a44;
  --accent:#22d3ee; --accent-2:#34d399;
}
*{box-sizing:border-box} html,body{margin:0;height:100%}
body{
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
  background:radial-gradient(1100px 600px at -10% -10%, rgba(34,211,238,.12), transparent 60%),
             radial-gradient(1200px 800px at 110% -10%, rgba(52,211,153,.12), transparent 60%), var(--bg);
  color:var(--text)
}
a{color:var(--accent)}
.header{position:sticky;top:0;z-index:50;background:rgba(11,16,32,.72);backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid var(--border)}
.max{max-width:1200px;margin:0 auto;padding:14px 20px}
.nav{display:flex;align-items:center;gap:14px}
.brand{display:flex;align-items:center;gap:10px}
.brand .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(145deg,var(--accent),var(--accent-2));display:grid;place-items:center;color:#0b1020;font-weight:800}
.brand .name{font-weight:700}
.nav .spacer{flex:1}
.tabs{display:flex;gap:8px;margin:10px auto 0;flex-wrap:wrap}
.tab{background:#0e152b;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
.tab.active{background:linear-gradient(145deg,var(--accent),var(--accent-2));color:#0b1020;border-color:transparent;font-weight:700}
main{max-width:1200px;margin:0 auto;padding:12px 20px 40px}
.grid{display:grid;grid-template-columns:360px 1fr;gap:18px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
h3{margin:0 0 10px}
.input, textarea, select, input[type="color"]{
  width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b1224;color:var(--text)
}
label{display:block;margin-bottom:6px;color:var(--muted)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0d1430;color:#8bf3ff;font-size:12px}
.messages{height:60vh;overflow:auto;display:flex;flex-direction:column;gap:10px;padding-right:4px}
.msg{max-width:78%;padding:10px 12px;border-radius:12px;line-height:1.35;white-space:pre-wrap}
.msg.bot{align-self:flex-start;background:#0d162e;border:1px solid var(--border)}
.msg.user{align-self:flex-end;background:rgba(34,211,238,.15);border:1px solid rgba(34,211,238,.5)}
.composer{display:flex;gap:8px;margin-top:8px} .composer input{flex:1}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
.kpi{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
.kpi-number{font-size:26px;font-weight:700}
.table-wrap{overflow:auto} table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
.hidden{display:none !important}
.small{font-size:12px;color:var(--muted)}
.btn{border:1px solid var(--border);background:linear-gradient(145deg,var(--accent),var(--accent-2));color:#08202a;font-weight:700;padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:0 6px 20px -8px rgba(34,211,238,.6)}
.btn.secondary{background:transparent;color:var(--text)}
.notice{font-size:12px;color:#ffd080}
.debug{font-family:ui-monospace,Consolas,monospace;background:#0b1224;border:1px dashed #24304c;border-radius:10px;padding:10px;white-space:pre-wrap;max-height:180px;overflow:auto}
</style>
</head>
<body>
<header class="header">
  <div class="max nav">
    <div class="brand">
      <div class="logo">üöó</div>
      <div class="name">Consultor de Autom√≥veis ‚Äî IA</div>
      <span class="badge">Prompt Editor</span>
    </div>
    <div class="spacer"></div>
    <div class="row">
      <label class="small">Endpoint</label>
      <input id="endpoint" class="input" style="width:360px" value="/api/chat_gemini" />
      <button class="btn secondary" id="testEP">Testar</button>
      <span id="epStatus" class="small"></span>
    </div>
  </div>
</header>

<div class="max">
  <div class="tabs" id="tabs">
    <button class="tab active" data-tab="chat">Chat</button>
    <button class="tab" data-tab="crm">CRM</button>
    <button class="tab" data-tab="analytics">Analytics</button>
    <button class="tab" data-tab="prompt">Prompt da IA</button>
  </div>
</div>

<main class="max">
  <!-- CHAT -->
  <section id="chat" class="tab-content">
    <div class="grid">
      <aside class="card">
        <h3>Lead atual</h3>
        <div id="leadSnapshot"><p class="small">Nenhum lead ainda.</p></div>
        <div class="row" style="margin-top:8px">
          <button class="btn secondary" id="btnSaveLead">Salvar lead</button>
          <button class="btn secondary" id="btnNewLead">Novo lead</button>
        </div>
        <hr/>
        <label>Follow-up (data/hora)</label>
        <input id="nextFollow" class="input" type="datetime-local"/>
        <input id="followNote" class="input" placeholder="Observa√ß√£o do follow-up"/>
        <button class="btn secondary" id="btnSetFollow">Salvar follow-up</button>
        <p id="followWarn" class="notice hidden">‚ö†Ô∏è Voc√™ tem follow-ups vencidos na aba Analytics.</p>
        <hr/>
        <label><input type="checkbox" id="autoAppt" /> Agendar automaticamente se a IA sugerir</label>
        <p class="small">O agendamento ser√° criado ao detectar ‚Äúvamos agendar‚Äù, ‚Äúmarcar‚Äù + uma data/hor√°rio reconhec√≠vel.</p>
        <hr/>
        <h3>Debug (JSON extra√≠do pela IA)</h3>
        <div id="debugBox" class="debug small">‚Äî</div>
      </aside>

      <div class="card">
        <div id="messages" class="messages"></div>
        <div class="composer">
          <input id="userInput" class="input" placeholder="Ex.: Quero um carro econ√¥mico para fam√≠lia de 4, at√© 150 mil parcelado" />
          <button class="btn" id="sendBtn">Enviar</button>
        </div>
      </div>
    </div>
  </section>

  <!-- CRM -->
  <section id="crm" class="tab-content hidden">
    <div class="kpis">
      <div class="kpi"><div class="kpi-number" id="kpiLeads">0</div><div>Leads</div></div>
      <div class="kpi"><div class="kpi-number" id="kpiQual">0</div><div>Qualificados</div></div>
      <div class="kpi"><div class="kpi-number" id="kpiRec">0</div><div>Recomenda√ß√£o enviada</div></div>
      <div class="kpi"><div class="kpi-number" id="kpiWon">0</div><div>Fechados</div></div>
    </div>
    <div class="card">
      <div class="row" style="margin-bottom:10px">
        <input class="input" id="search" placeholder="Buscar por nome, telefone, perfil, status..."/>
        <button class="btn secondary" id="exportCsv">Exportar CSV</button>
        <button class="btn secondary" id="clearCrm">Limpar CRM</button>
      </div>
      <div class="table-wrap">
        <table id="crmTable">
          <thead><tr><th>Status</th><th>Nome</th><th>Perfil</th><th>Telefone</th><th>Score</th><th>Follow-up</th><th>Atualizado</th><th>A√ß√µes</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Analytics -->
  <section id="analytics" class="tab-content hidden">
    <div class="card">
      <h3>Vis√£o geral</h3>
      <div class="kpis">
        <div class="kpi"><div class="kpi-number" id="aLeads">0</div><div>Leads</div></div>
        <div class="kpi"><div class="kpi-number" id="aPreco">0</div><div>Obje√ß√µes: pre√ßo</div></div>
        <div class="kpi"><div class="kpi-number" id="aConsumo">0</div><div>Prioridade: consumo</div></div>
        <div class="kpi"><div class="kpi-number" id="aEspaco">0</div><div>Prioridade: espa√ßo</div></div>
      </div>
      <h3>Pr√≥ximos follow-ups</h3>
      <ul id="followups"></ul>
    </div>
  </section>

  <!-- Prompt da IA -->
  <section id="prompt" class="tab-content hidden">
    <div class="card">
      <h3>Prompt do Gemini (System)</h3>
      <p class="small">Personalize o comportamento do consultor. Voc√™ pode usar vari√°veis simples: <code>{{biz}}</code>, <code>{{agent}}</code>.</p>
      <textarea id="promptEditor" class="input" rows="14"></textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="savePrompt">Salvar Prompt</button>
        <button class="btn secondary" id="resetPrompt">Restaurar padr√£o</button>
      </div>
      <hr/>
      <label>Agendamento inteligente</label>
      <p class="small">Frases como ‚Äúvamos agendar amanh√£ 15:00‚Äù ser√£o detectadas e o follow-up criado automaticamente (se a caixa na aba Chat estiver marcada).</p>
    </div>
  </section>
</main>

<script>
/* ================== ESTADO & STORAGE ================== */
const LS = { SETTINGS:"auto_settings", TRAINING:"auto_training", CRM:"auto_crm", PROMPT:"auto_prompt" };
let crm = JSON.parse(localStorage.getItem(LS.CRM)||"null") || [];
let settings = JSON.parse(localStorage.getItem(LS.SETTINGS)||"null") || {
  agent:"Tiago", biz:"Consultoria Auto Tiago"
};
let customPrompt = localStorage.getItem(LS.PROMPT) || `Voc√™ √© um consultor de autom√≥veis da {{biz}} chamado {{agent}}.
Regras:
- Tom consultivo, objetivo e claro; responda SEM colchetes, marcadores de template ou placeholders.
- Sempre que poss√≠vel, ofere√ßa 2‚Äì3 op√ß√µes j√° completas (modelo/ano, consumo aproximado, pontos fortes/fracos, custo recorrente t√≠pico), sem ‚Äúinserir dados‚Äù.
- Quando houver inten√ß√£o de compra real, solicite nome e telefone para formalizar.
- Explore prioridades do cliente (consumo, conforto, tecnologia, desempenho, espa√ßo, seguran√ßa), uso (cidade/rodovia/app/fam√≠lia), or√ßamento (√† vista e mensal) e CEP (para no√ß√£o de seguro).
- Se o cliente mencionar ‚Äúagendar‚Äù, confirme uma data/hor√°rio.
Formate respostas em par√°grafos curtos e com listas simples quando √∫til.
`;

/* ================== UI B√ÅSICA / TABS ================== */
const tabs = document.querySelectorAll(".tab");
const sections = document.querySelectorAll(".tab-content");
tabs.forEach(b=> b.addEventListener("click", ()=>{
  tabs.forEach(x=>x.classList.remove("active"));
  sections.forEach(s=>s.classList.add("hidden"));
  b.classList.add("active");
  document.getElementById(b.dataset.tab).classList.remove("hidden");
  if (b.dataset.tab === "crm") renderCRM();
  if (b.dataset.tab === "analytics") renderAnalytics();
  if (b.dataset.tab === "prompt") loadPromptEditor();
}));

/* ================== ELEMENTOS ================== */
const messagesEl = document.getElementById("messages");
const userInput = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");
const endpointEl = document.getElementById("endpoint");
const testEP = document.getElementById("testEP");
const epStatus = document.getElementById("epStatus");
const autoApptEl = document.getElementById("autoAppt");
const debugBox = document.getElementById("debugBox");

document.getElementById("btnSaveLead").onclick = onSaveLead;
document.getElementById("btnNewLead").onclick = onNewLead;
document.getElementById("btnSetFollow").onclick = onManualFollow;
document.getElementById("exportCsv").onclick = exportCsv;
document.getElementById("clearCrm").onclick = clearCrm;
document.getElementById("search").oninput = renderCRM;
testEP.onclick = doTestEP;
sendBtn.onclick = handleSend;
userInput.addEventListener("keydown", e=> (e.key==="Enter") && handleSend());

/* ================== PROMPT EDITOR ================== */
const promptEditor = document.getElementById("promptEditor");
const savePrompt = document.getElementById("savePrompt");
const resetPrompt = document.getElementById("resetPrompt");
savePrompt.onclick = ()=>{
  customPrompt = promptEditor.value || customPrompt;
  localStorage.setItem(LS.PROMPT, customPrompt);
  alert("Prompt salvo!");
};
resetPrompt.onclick = ()=>{
  localStorage.removeItem(LS.PROMPT);
  customPrompt = undefined;
  loadPromptEditor();
  alert("Prompt restaurado.");
};
function loadPromptEditor(){
  const p = localStorage.getItem(LS.PROMPT) || defaultPrompt();
  promptEditor.value = p;
}
function defaultPrompt(){ return `Voc√™ √© um consultor de autom√≥veis da {{biz}} chamado {{agent}}.
Regras:
- Tom consultivo, objetivo e claro; responda SEM colchetes, marcadores de template ou placeholders.
- Sempre que poss√≠vel, ofere√ßa 2‚Äì3 op√ß√µes j√° completas (modelo/ano, consumo aproximado, pontos fortes/fracos, custo recorrente t√≠pico), sem ‚Äúinserir dados‚Äù.
- Quando houver inten√ß√£o de compra real, solicite nome e telefone para formalizar.
- Explore prioridades do cliente (consumo, conforto, tecnologia, desempenho, espa√ßo, seguran√ßa), uso (cidade/rodovia/app/fam√≠lia), or√ßamento (√† vista e mensal) e CEP (para no√ß√£o de seguro).
- Se o cliente mencionar ‚Äúagendar‚Äù, confirme uma data/hor√°rio.
Formate respostas em par√°grafos curtos e com listas simples quando √∫til.`; }

/* ================== LEADS / CHAT ================== */
let currentLead = newLead();
let chatStarted=false;

function newLead(){
  return {
    id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
    name:"", phone:"", email:"", status:"Novo", score:0,
    new_or_used:"", model_hint:"", budget_month:"", budget_cash:"", use_case:"", annual_km:"",
    priorities:[], fuel:"", gearbox:"", cep:"",
    next_followup_at:null, followup_note:"",
    created_at:new Date().toISOString(), updated_at:new Date().toISOString(),
    transcript:[]
  };
}

function appendMsg(sender, text){
  const div = document.createElement("div"); 
  div.className = "msg " + (sender === "bot" ? "bot" : "user"); 
  div.textContent = sanitize(text);
  messagesEl.appendChild(div); messagesEl.scrollTop = messagesEl.scrollHeight;
}
function bot(t){ appendMsg("bot", t); currentLead.transcript.push({who:settings.agent, text:sanitize(t), ts:new Date().toISOString()}); }
function user(t){ appendMsg("user", t); currentLead.transcript.push({who:"Cliente", text:sanitize(t), ts:new Date().toISOString()}); }

function sanitize(s){
  return String(s||"")
    .replace(/\[(insira|inserir).*?\]/gi,"")
    .replace(/\{\{.*?\}\}/g,"")
    .replace(/\s{2,}/g," ")
    .trim();
}

/* ================== FLUXO COM IA ================== */
async function handleSend(){
  const t = userInput.value.trim(); if (!t) return; userInput.value = "";
  user(t);
  if (!chatStarted){ chatStarted = true; bot("Perfeito! Para come√ßar, novo ou usado? E qual seu or√ßamento (√† vista e/ou mensal) e uso principal?"); return; }

  // 1) Chama a IA com seu prompt personalizado
  const sys = renderPrompt();
  const convo = currentLead.transcript.slice(-20);
  const aiResp = await callChat(sys, convo);
  if (aiResp.ok){ bot(aiResp.text||"(sem resposta)"); } else { bot("Falha no endpoint: "+aiResp.status); return; }

  // 2) Extrai dados estruturados (JSON) e mescla no lead
  const extracted = await aiExtractLead(convo);
  if (extracted){ mergeLeadData(extracted); autoScoreAndSave(); }

  // 3) Se IA sugerir agendamento e "autoAppt" estiver ligado, cria automaticamente
  if (autoApptEl.checked && detectScheduleIntent(aiResp.text||"")){
    const when = parseDateTimePtBR(aiResp.text) || nearestWorkSlot();
    if (when){
      const note = await aiFollowupNote(convo);
      currentLead.next_followup_at = when.toISOString();
      currentLead.followup_note = note || defaultFollowNote();
      autoScoreAndSave(); updateLeadSnapshot();
      bot(`Agendado automaticamente para ${when.toLocaleString()}.`);
    }else{
      bot("Posso agendar para voc√™. Qual data e hor√°rio preferidos? (ex.: 12/09 14:30)");
    }
  }
}

function renderPrompt(){
  const tpl = (localStorage.getItem(LS.PROMPT) || customPrompt || defaultPrompt());
  return tpl.replace(/\{\{biz\}\}/g, settings.biz).replace(/\{\{agent\}\}/g, settings.agent);
}

async function callChat(system, messages){
  try{
    const r = await fetch(endpointEl.value||"/api/chat_gemini",{
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ system, messages })
    });
    const j = await r.json();
    return { ok:r.ok, status:r.status, text:j.text||"" };
  }catch(e){ return { ok:false, status:"ERR", text:String(e.message) }; }
}

/* ============ EXTRA√á√ÉO DE DADOS POR IA (JSON) ============ */
async function aiExtractLead(messages){
  try{
    const convo = messages.map(m=>`${m.who}: ${m.text}`).join("\n");
    const sys = `Apenas devolva JSON v√°lido (sem texto extra) com os campos:
{
 "name": string|null, "phone": string|null,
 "new_or_used": "Novo"|"Usado"|null,
 "model_hint": string|null,
 "budget_cash": string|null, "budget_month": string|null,
 "use_case": string|null, "annual_km": string|null,
 "priorities": string[]|null,
 "fuel": string|null, "gearbox": string|null, "cep": string|null
}
- Telefone apenas d√≠gitos (10‚Äì14). N√£o invente valores.`;

    const r = await fetch(endpointEl.value||"/api/chat_gemini",{
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ system: sys, messages:[{who:"Transcri√ß√£o", text: convo}] })
    });
    const j = await r.json();
    const raw = sanitize(j.text||"");
    let data=null; try{ data = JSON.parse(raw); } catch(e){ /* pode ser que a IA traga code fences; tenta limpar */ 
      const m = raw.match(/\{[\s\S]*\}$/); if (m){ try{ data = JSON.parse(m[0]); }catch(_){} }
    }
    debugBox.textContent = data? JSON.stringify(data,null,2) : "(sem JSON v√°lido)";
    return data||null;
  }catch(e){
    debugBox.textContent = "erro: "+e.message;
    return null;
  }
}

function mergeLeadData(p){
  const L=currentLead;
  const assign = (k)=>{ if (p[k]) L[k]=p[k]; };
  ["name","phone","new_or_used","model_hint","budget_cash","budget_month","use_case","annual_km","fuel","gearbox","cep"].forEach(assign);
  if (Array.isArray(p.priorities) && p.priorities.length){ L.priorities = p.priorities; }
  L.updated_at = new Date().toISOString();
  updateLeadSnapshot();
}

function autoScoreAndSave(){
  currentLead.score = scoreLead(currentLead);
  const i = crm.findIndex(x=>x.id===currentLead.id);
  if (i>=0) crm[i]=currentLead; else crm.push(currentLead);
  localStorage.setItem(LS.CRM, JSON.stringify(crm));
  renderCRM();
}

/* ================== AGENDAMENTO ================== */
function defaultFollowNote(){
  const L=currentLead;
  return `Contato com ${L.name||"Lead"}: validar or√ßamento R$${L.budget_month||L.budget_cash||"?"}/m√™s, prioridades ${ (L.priorities||[]).slice(0,3).join("/")||"?" }.`;
}
async function aiFollowupNote(messages){
  try{
    const convo = messages.map(m=>`${m.who}: ${m.text}`).join("\n");
    const sys = `Gerar UMA linha breve de nota para follow-up (sem emojis), com objetivo claro para o pr√≥ximo contato.`;
    const r = await fetch(endpointEl.value||"/api/chat_gemini",{
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ system: sys, messages:[{who:"Transcri√ß√£o", text: convo}] })
    });
    const j = await r.json();
    return sanitize(j.text||"").slice(0,240);
  }catch(e){ return ""; }
}

function detectScheduleIntent(t){
  const s = t.toLowerCase();
  return /(agendar|marcar|reuni[a√£]o|liga√ß√£o|ligacao|chamada)/.test(s);
}

function parseDateTimePtBR(s){
  const t = s.replace(/\s+√†s\s+/i," ").replace(/\s+as\s+/i," ").replace("h",":");
  const m = t.match(/(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?(?:\s+(\d{1,2})(?::(\d{2}))?)?/);
  if(!m) return null;
  let [_,dd,MM,yyyy,hh,mm] = m;
  const now = new Date();
  const year = yyyy? (yyyy.length===2? 2000+parseInt(yyyy): parseInt(yyyy)) : now.getFullYear();
  const date = new Date(year, parseInt(MM)-1, parseInt(dd), parseInt(hh||"9"), parseInt(mm||"0"));
  return isNaN(date.getTime())? null : date;
}
function nearestWorkSlot(){
  const d = new Date();
  d.setMinutes(d.getMinutes()+90);
  if (d.getHours() < 9) { d.setHours(9,0,0,0); }
  if (d.getHours() > 18) { d.setDate(d.getDate()+1); d.setHours(9,0,0,0); }
  return d;
}

function onManualFollow(){
  const dt = document.getElementById("nextFollow").value;
  const note = document.getElementById("followNote").value;
  currentLead.next_followup_at = dt? new Date(dt).toISOString(): null;
  currentLead.followup_note = sanitize(note||"");
  autoScoreAndSave(); updateLeadSnapshot();
  alert("Follow-up salvo (local).");
}

/* ================== BOT√ïES & AUXILIARES ================== */
function onSaveLead(){ autoScoreAndSave(); alert("Lead salvo no CRM (local)."); }
function onNewLead(){
  currentLead = newLead(); chatStarted=false;
  messagesEl.innerHTML = "";
  bot(`Ol√°! Eu sou ${settings.agent} da ${settings.biz}.`);
  bot("Prefere carro novo ou usado? Qual or√ßamento e uso principal?");
  updateLeadSnapshot();
}

async function doTestEP(){
  epStatus.textContent = "Testando...";
  const r = await fetch(endpointEl.value||"/api/chat_gemini",{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ system:"teste", messages:[{who:"Cliente", text:"Ol√°!"}] })
  }).catch(e=>({ok:false,status:e.message}));
  if (r && r.ok !== undefined){
    const txt = r.ok ? "OK" : "Falha";
    epStatus.textContent = `${txt} (${r.status||"?"})`;
  }else{
    epStatus.textContent = "Erro de rede";
  }
}

/* ================== SNAPSHOT / SCORE ================== */
function scoreLead(L){
  let s=0;
  if (L.new_or_used) s+=10;
  if (L.model_hint) s+=10;
  if (L.budget_cash||L.budget_month) s+=20;
  if (L.use_case) s+=10;
  if ((L.priorities||[]).length) s+=10;
  if (L.phone && L.phone.length>=10) s+=30;
  if (L.cep) s+=5;
  if ((L.priorities||[]).join(",").match(/consumo|seguran|espa|famil/i)) s+=5;
  return Math.min(100,s);
}

function updateLeadSnapshot(){
  const L=currentLead;
  L.updated_at = new Date().toISOString();
  document.getElementById("leadSnapshot").innerHTML = `
    <div class="badge">${L.status}</div>
    <p><strong>${sanitize(L.name)||"(sem nome)"} </strong> ‚Ä¢ Tel ${L.phone||"-"} ‚Ä¢ Score ${L.score||0}</p>
    <p>${L.new_or_used||"-"} ‚Ä¢ ${sanitize(L.model_hint)||"-"}</p>
    <p>Or√ßamento: √† vista R$ ${L.budget_cash||"-"} ‚Ä¢ mensal R$ ${L.budget_month||"-"}</p>
    <p>Uso: ${sanitize(L.use_case)||"-"} ‚Ä¢ km/ano ${L.annual_km||"-"} ‚Ä¢ CEP ${L.cep||"-"}</p>
    <p>Prefer√™ncias: ${sanitize((L.priorities||[]).join(", "))||"-"} ‚Ä¢ ${L.fuel||"-"} ‚Ä¢ ${L.gearbox||"-"}</p>
    <p>Follow-up: ${L.next_followup_at? new Date(L.next_followup_at).toLocaleString():"-"} ‚Ä¢ ${sanitize(L.followup_note||"")}</p>
  `;
  const warn = document.getElementById("followWarn");
  const overdue = crm.some(x=>x.next_followup_at && new Date(x.next_followup_at).getTime() < Date.now());
  warn.classList.toggle("hidden", !overdue);
}

/* ================== CRM / ANALYTICS ================== */
function renderCRM(){
  const tbody=document.querySelector("#crmTable tbody");
  const q=(document.getElementById("search").value||"").toLowerCase();
  const list=crm.filter(L=> !q || (`${L.name} ${L.phone} ${L.status} ${L.model_hint}`).toLowerCase().includes(q));
  setText("kpiLeads", crm.length);
  setText("kpiQual", crm.filter(x=>x.status==="Qualificado").length);
  setText("kpiRec",  crm.filter(x=>x.status==="Recomenda√ß√£o enviada").length);
  setText("kpiWon",  crm.filter(x=>x.status==="Fechado").length);
  tbody.innerHTML="";
  list.forEach(L=>{
    const perfil = `${L.new_or_used||"-"} | ${sanitize(L.model_hint)||"-"} | ${(L.priorities||[]).slice(0,2).join("/")||"-"}`;
    const nf = L.next_followup_at ? new Date(L.next_followup_at).toLocaleString() : "-";
    const tr=document.createElement("tr");
    tr.innerHTML = `<td><span class="badge">${L.status}</span></td>
      <td>${sanitize(L.name)||"-"}</td><td>${perfil}</td><td>${L.phone||"-"}</td>
      <td>${L.score||0}</td><td>${nf}</td>
      <td>${new Date(L.updated_at||L.created_at).toLocaleString()}</td>
      <td>
        <button class="btn secondary open" data-id="${L.id}">Abrir</button>
        <button class="btn secondary stage" data-id="${L.id}">Avan√ßar</button>
        <button class="btn secondary del" data-id="${L.id}">Excluir</button>
      </td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll(".open").forEach(b=> b.onclick = (e)=>{
    const id=e.target.getAttribute("data-id"); const L=crm.find(x=>x.id===id); if(!L) return;
    currentLead=JSON.parse(JSON.stringify(L));
    document.querySelector('.tab[data-tab="chat"]').click();
    bot("Lead reaberto no chat."); updateLeadSnapshot();
  });
  tbody.querySelectorAll(".stage").forEach(b=> b.onclick = (e)=>{
    const id=e.target.getAttribute("data-id"); const L=crm.find(x=>x.id===id); if(!L) return;
    const order=["Novo","Qualificado","Recomenda√ß√£o enviada","Fechamento","Fechado"];
    const i=order.indexOf(L.status); L.status=order[Math.min(order.length-1, Math.max(0,i+1))]||"Qualificado";
    L.updated_at=new Date().toISOString(); localStorage.setItem(LS.CRM, JSON.stringify(crm)); renderCRM();
  });
  tbody.querySelectorAll(".del").forEach(b=> b.onclick = (e)=>{
    const id=e.target.getAttribute("data-id");
    crm = crm.filter(x=>x.id!==id); localStorage.setItem(LS.CRM, JSON.stringify(crm)); renderCRM();
  });
}
function renderAnalytics(){
  setText("aLeads", crm.length);
  let preco=0, consumo=0, espaco=0;
  crm.forEach(L=> (L.transcript||[]).forEach(m=>{
    const t=(m.text||"").toLowerCase();
    if (t.includes("pre√ßo")||t.includes("preco")||t.includes("caro")) preco++;
    if (t.includes("consumo")) consumo++;
    if (t.includes("espa√ßo")||t.includes("espaco")||t.includes("porta-malas")) espaco++;
  }));
  setText("aPreco", preco); setText("aConsumo", consumo); setText("aEspaco", espaco);
  const ul=document.getElementById("followups"); ul.innerHTML="";
  crm.filter(L=>L.next_followup_at).sort((a,b)=> new Date(a.next_followup_at)-new Date(b.next_followup_at)).slice(0,10).forEach(L=>{
    const li=document.createElement("li"); li.textContent = `${sanitize(L.name)||"Lead"} ‚Ä¢ ${new Date(L.next_followup_at).toLocaleString()} ‚Ä¢ ${sanitize(L.followup_note||"")}`; ul.appendChild(li);
  });
}
function setText(id,val){ const el=document.getElementById(id); if(el) el.textContent=val; }

/* ================== EXPORT / CLEAR ================== */
function exportCsv(){
  const headers=["id","status","name","phone","new_or_used","model_hint","budget_cash","budget_month","use_case","annual_km","priorities","fuel","gearbox","cep","score","next_followup_at","followup_note","created_at","updated_at"];
  const rows=[headers.join(",")];
  crm.forEach(L=>{
    const row=headers.map(h=>{
      const v=(h==="priorities")? (L.priorities||[]).join("|") : (L[h]??"");
      return `"${String(v).replace(/"/g,'""')}"`;
    }).join(",");
    rows.push(row);
  });
  const blob=new Blob([rows.join("\n")],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="crm.csv"; a.click(); URL.revokeObjectURL(url);
}
function clearCrm(){
  if (!confirm("Apagar todos os leads do CRM (local)?")) return;
  crm=[]; localStorage.setItem(LS.CRM, JSON.stringify(crm)); renderCRM();
}

/* ================== BOOT ================== */
function boot(){
  document.querySelector('.tab[data-tab="chat"]').click();
  onNewLead(); // cria um lead inicial e cumprimenta
}
boot();
</script>
</body>
</html>
